<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tile & Sanitaryware Inventory</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <!-- âœ… html2canvas for image generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Ã¢Å“â€¦ ADD THIS LINE -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


  <style>
    body{background:#f8f9fa;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif}
    .table-explorer { background:#fff; border-radius:6px; overflow:hidden; }
    .file-icon { font-size:1.15rem; display:inline-block; width:1.6rem; text-align:center; }
    .stock-badge{font-size:.85rem;padding:.25rem .5rem;border-radius:.5rem}
    .mobile-list{display:none}
    .mobile-item{background:#fff;padding:.75rem;border-radius:.5rem;margin-bottom:.7rem;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .btn-action-sm{padding:.25rem .5rem;font-size:.85rem}
    .sync-indicator{position:fixed;top:70px;left:20px;background:#fff;padding:8px 12px;border-radius:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);display:none;z-index:1000}
   /* Sales grid mobile transforms */
@media (max-width:768px) {
  .desktop-table { display:none !important; }
  .mobile-list { display:block !important; }
  /* Make table rows card-like */
  .grid-table thead { display:none; }
  .grid-table tbody tr { display:block; margin-bottom:12px; padding:12px; border:1px solid #e9ecef; border-radius:8px; background:#fff; }
  .grid-table td { display:block; width:100%; padding:.35rem 0; border:0; }
  .grid-row-number { float:right; font-size:.85rem; color:#6c757d; }
  .product-select, .qty-input, .price-input { width:100% !important; font-size:16px; height:44px; }
  .mobile-two-col { display:flex; gap:10px; }
  .mobile-two-col > div { flex:1; }
  .modal-dialog { margin:.5rem; max-width: calc(100% - 1rem); }
  .modal-body { max-height: calc(100vh - 200px); overflow-y:auto; -webkit-overflow-scrolling: touch; }
  .modal-footer { position: sticky; bottom:0; background: white; z-index:10; box-shadow:0 -2px 10px rgba(0,0,0,.08); }
}

/* ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Additional mobile fixes for Record Sale modal */
@media (max-width: 768px) {
    /* Specific fixes for salesModal only */
    #salesModal .modal-dialog {
        margin: 0.25rem;
        max-width: calc(100% - 0.5rem);
    }
    
    #salesModal .modal-body {
        padding: 0.75rem 0.5rem;
    }
    
    /* Smaller font for sales grid on mobile */
    #salesModal .grid-table {
        font-size: 0.85rem;
    }
    
    /* Add labels before each field for clarity */
    #salesModal .grid-table td:nth-child(2)::before { 
        content: "Product: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(3)::before { 
        content: "Size: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(4)::before { 
        content: "Qty: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(5)::before { 
        content: "Unit: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(6)::before { 
        content: "Price: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    #salesModal .grid-table td:nth-child(7)::before { 
        content: "Total: "; 
        font-weight: bold; 
        color: #6c757d;
        font-size: 0.75rem;
    }
    
    /* Hide row number on mobile */
    #salesModal .grid-table td:nth-child(1) {
        display: none;
    }
    
    /* Make total more prominent */
    #salesModal .grid-table td:nth-child(7) {
        font-size: 1.1rem;
        color: #28a745;
        font-weight: bold;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 2px solid #28a745;
    }
    
    /* Ensure inputs are touch-friendly */
    #salesModal .product-select,
    #salesModal .qty-input {
        width: 100% !important;
        font-size: 16px !important;
        height: 44px;
        margin-top: 4px;
    }
    
    /* Multi-select dropdown smaller on mobile */
    .multi-select-options {
        max-height: 200px;
    }
    
    /* Stack modal footer buttons vertically */
    #salesModal .modal-footer {
        flex-direction: column;
        gap: 8px;
    }
    
    #salesModal .modal-footer button {
        width: 100%;
        margin: 0;
    }
    
    /* Smaller buttons on mobile */
    #salesModal .btn-sm {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
    }
}

/* ==========================================
   SUCCESS TOAST NOTIFICATION
   ========================================== */

.toast-notification {
  position: fixed;
  top: 80px;
  right: 20px;
  background: white;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  border-left: 4px solid #28a745;
  z-index: 10000;
  opacity: 0;
  transform: translateX(400px);
  transition: all 0.3s ease;
  max-width: 350px;
}

.toast-notification.show {
  opacity: 1;
  transform: translateX(0);
}

/* ===== PHOTO PRODUCT STYLES ===== */
.upload-area {
  border: 3px dashed #2196F3;
  border-radius: 15px;
  padding: 30px 20px;
  margin: 20px 0;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #f8f9ff;
  text-align: center;
}

.upload-area:hover {
  border-color: #1976D2;
  background: #e3f2fd;
}

.upload-icon {
  font-size: 3rem;
  color: #2196F3;
  margin-bottom: 10px;
}

.upload-text {
  color: #666;
  font-size: 1rem;
  margin-bottom: 15px;
}

.preview-container {
  margin: 20px 0;
  display: none;
  text-align: center;
}

.preview-image {
  max-width: 100%;
  max-height: 250px;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  margin-bottom: 15px;
}

#photoProductGrid .card {
  transition: transform 0.2s, box-shadow 0.2s;
}

#photoProductGrid .card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.15) !important;
}

#photoProductGrid .card-img-top {
  cursor: pointer;
  transition: transform 0.3s;
}

#photoProductGrid .card-img-top:hover {
  transform: scale(1.05);
}

.photo-thumbnail-small {
  width: 40px;
  height: 40px;
  object-fit: cover;
  border-radius: 4px;
  border: 2px solid #e0e0e0;
  margin-right: 8px;
}

.loading-spinner {
  display: none;
  text-align: center;
  margin: 20px 0;
}

.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #2196F3;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}




    
/* Background sync indicator (optional) */
#backgroundSyncStatus {
  display: none;
  font-size: 0.85rem;
  color: #6c757d;
  padding: 0.25rem 0.75rem;
  background: rgba(13, 110, 253, 0.1);
  border-radius: 20px;
}

#backgroundSyncStatus i {
  color: #0d6efd;
  animation: spin 2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}




    
/* ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Mobile Recent Sales Table Optimization */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.75rem;
        overflow-x: auto;
    }
    
    #salesList td {
        padding: 0.4rem 0.2rem !important;
        font-size: 0.75rem;
    }
    
    #salesList th {
        padding: 0.5rem 0.2rem !important;
        font-size: 0.8rem;
    }
    
    #salesList td:nth-child(1),
    #salesList th:nth-child(1) {
        max-width: 85px;
        word-wrap: break-word;
        font-size: 0.7rem;
        line-height: 1.2;
    }
    
    #salesList td:nth-child(2),
    #salesList th:nth-child(2) {
        max-width: 110px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    #salesList td:nth-child(3),
    #salesList th:nth-child(3) {
        text-align: center;
        max-width: 45px;
        padding-left: 0.1rem !important;
        padding-right: 0.1rem !important;
    }
    
    #salesList td:nth-child(4),
    #salesList th:nth-child(4) {
        text-align: center;
        max-width: 45px;
        font-size: 0.7rem;
        padding-left: 0.1rem !important;
        padding-right: 0.1rem !important;
    }
    
    #salesList td:nth-child(5) {
        font-weight: bold;
        color: #28a745;
        font-size: 0.85rem;
        text-align: right;
        max-width: 80px;
    }
    
    #salesList th:nth-child(5) {
        text-align: right;
        max-width: 80px;
    }
}


    /* Multi-Select Dropdown Styles */
.multi-select-dropdown {
    position: relative;
}

.multi-select-toggle {
    cursor: pointer;
}

.multi-select-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1050;
    padding: 10px;
    display: none;
}

.multi-select-options.show {
    display: block;
}

.multi-select-list {
    max-height: 250px;
    overflow-y: auto;
}

.multi-select-item {
    padding: 8px 10px;
    cursor: pointer;
    border-radius: 4px;
}

.multi-select-item:hover {
    background-color: #f8f9fa;
}

.multi-select-item label {
    cursor: pointer;
    margin-bottom: 0;
    width: 100%;
}

/* ==========================================
   QUICK CREATE PLUS ICON 
   ========================================== */

/* Floating Plus Button */
.quick-create-btn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 50%;
  border: none;
  color: white;
  font-size: 28px;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
  z-index: 1000;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.quick-create-btn:hover {
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
}

.quick-create-btn.active {
  transform: rotate(45deg);
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

/* Dropdown Menu */
.quick-create-menu {
  position: fixed;
  bottom: 100px;
  right: 30px;
  width: 320px;
  max-height: 600px;
  overflow-y: auto;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  z-index: 999;
  display: none;
  animation: slideUp 0.3s ease-out;
}

.quick-create-menu.show {
  display: block;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Menu Header */
.quick-create-header {
  padding: 20px;
  border-bottom: 1px solid #e0e0e0;
  font-size: 18px;
  font-weight: bold;
  color: #333;
}

/* Menu Sections */
.quick-create-section {
  padding: 15px 20px 10px 20px;
}

.quick-create-section-title {
  font-size: 12px;
  font-weight: 600;
  color: #999;
  text-transform: uppercase;
  margin-bottom: 10px;
  letter-spacing: 0.5px;
}

/* Menu Items */
.quick-create-item {
  display: flex;
  align-items: center;
  padding: 12px 15px;
  margin-bottom: 5px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: #333;
  text-decoration: none;
}

.quick-create-item:hover {
  background: #f5f5f5;
  transform: translateX(5px);
}

.quick-create-item i {
  font-size: 18px;
  margin-right: 12px;
  width: 20px;
  text-align: center;
  color: #667eea;
}

.quick-create-item span {
  font-size: 14px;
  font-weight: 500;
}

/* Disabled items (for later implementation) */
.quick-create-item.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.quick-create-item.disabled:hover {
  background: transparent;
  transform: none;
}

/* Scrollbar styling */
.quick-create-menu::-webkit-scrollbar {
  width: 6px;
}

.quick-create-menu::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.quick-create-menu::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 10px;
}

.quick-create-menu::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .quick-create-menu {
    right: 15px;
    width: calc(100vw - 30px);
    max-width: 320px;
  }
  
  .quick-create-btn {
    right: 15px;
    bottom: 20px;
  }
}









    

  </style>
</head>
<body>



<div id="authScreen" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999;">
  <div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card shadow-lg" style="max-width: 420px; width: 100%; border-radius: 15px;">
      <div class="card-body text-center p-5">
        <div class="mb-4">
          <i class="bi bi-building" style="font-size: 4rem; color: #0d6efd;"></i>
        </div>
        <h2 class="mb-3">Tile & Sanitaryware Inventory</h2>
        <p class="text-muted mb-4">Sign in to access inventory</p>
        
        <!-- Ã¢Å“â€¦ NEW: Email + Password Form -->
        <form id="emailAuthForm" onsubmit="handleEmailPasswordAuth(event)">
          <div class="mb-3">
            <input 
              type="email" 
              id="userEmailInput" 
              class="form-control form-control-lg" 
              placeholder="Email address" 
              required
              autocomplete="email"
              style="border-radius: 10px; text-align: center;"
            >
          </div>
          
          <!-- Ã¢Å“â€¦ NEW: Password Input with Toggle -->
          <div class="mb-3 position-relative">
            <input 
              type="password" 
              id="userPasswordInput" 
              class="form-control form-control-lg" 
              placeholder="Password" 
              required
              autocomplete="current-password"
              style="border-radius: 10px; text-align: center; padding-right: 45px;"
            >
            <button 
              type="button" 
              class="btn btn-link position-absolute" 
              onclick="togglePasswordVisibility()"
              style="right: 10px; top: 50%; transform: translateY(-50%); text-decoration: none; color: #6c757d;"
            >
              <i id="passwordToggleIcon" class="bi bi-eye"></i>
            </button>
          </div>
          
          <button type="submit" id="loginButton" class="btn btn-primary btn-lg w-100" style="border-radius: 10px;">
            <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
          </button>
        </form>
        
        <div class="text-muted mt-4" style="font-size: 0.875rem;">
          <i class="bi bi-lock-fill me-1"></i> Secure access with password
        </div>
      </div>
    </div>
  </div>
</div>




<!-- App Content (hidden until authenticated) -->
<div id="appContent" style="display:none;">

  <!-- YOUR EXISTING NAVBAR, DASHBOARD, ETC. GOES HERE -->

  
  <!-- Sync indicator -->
  <div id="syncIndicator" class="sync-indicator"><i class="bi bi-arrow-repeat"></i> <span id="syncText">Syncing...</span></div>

  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-primary sticky-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1"><i class="bi bi-boxes"></i> Tile & Sanitaryware Inventory</span>
      <div>
        <button id="refreshBtn" class="btn btn-light btn-sm me-2" onclick="manualRefresh()"><i id="refreshIcon" class="bi bi-arrow-clockwise"></i> Refresh</button>
        <button class="btn btn-light btn-sm me-2" onclick="exportData()"><i class="bi bi-download"></i> Backup</button>
        <button class="btn btn-light btn-sm" onclick="importData()"><i class="bi bi-upload"></i> Restore</button>
        <div class="d-flex align-items-center">
  <i class="bi bi-person-circle me-2" style="font-size: 1.5rem;"></i>
  <span id="userName" class="me-3">User</span>

  <!-- Ã¢Å“â€¦ NEW: Background sync indicator -->
  <div id="backgroundSyncStatus">
    <i class="bi bi-cloud-upload-fill"></i>
    <span>Syncing</span>
  </div>


          
  <!-- Ã¢Å“â€¦ NEW: Change Password Button -->
  <button class="btn btn-outline-light btn-sm me-2" onclick="openChangePasswordModal()">
    <i class="bi bi-key me-1"></i>Change Password
  </button>
  
  <button class="btn btn-outline-light btn-sm" onclick="signOut()">
    <i class="bi bi-box-arrow-right me-1"></i>Sign Out
  </button>
</div>



        <!-- ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: View Invoices Button -->
      <button class="btn btn-success btn-sm" onclick="viewSavedInvoices()">
        <i class="bi bi-receipt-cutoff"></i> View Invoices
      </button>
    </div>
  </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-4">
    <!-- Actions -->
    <div class="row mb-4">
      <div class="text-center my-3">
  <button class="btn btn-success me-2" onclick="showAddProduct()">
    <i class="bi bi-plus-circle"></i> Add Product
  </button>
  
  <!-- âœ… NEW: Photo Product Button -->
  <button class="btn btn-primary me-2" onclick="openPhotoProductModal()">
    <i class="bi bi-camera"></i> Product by Photo
  </button>
  
  <button class="btn btn-info" onclick="openSalesModal()">
    <i class="bi bi-cart"></i> Record Sale
  </button>
</div>


    <!-- Summary -->
    <div class="row mb-4">
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-box-seam text-primary" style="font-size:2rem"></i><h3 id="totalProducts" class="mt-2">0</h3><p class="text-muted mb-0">Total Products</p></div></div></div>
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-currency-rupee text-success" style="font-size:2rem"></i><h3 id="salesToday" class="mt-2">Ã¢â€šÂ¹0</h3><p class="text-muted mb-0">Sales Today</p></div></div></div>
      <div class="col-md-4 mb-3"><div class="card text-center shadow-sm"><div class="card-body"><i class="bi bi-exclamation-triangle text-danger" style="font-size:2rem"></i><h3 id="lowStock" class="mt-2">0</h3><p class="text-muted mb-0">Low Stock Items</p></div></div></div>
    </div>

    <!-- Search -->
    <div class="row mb-3">
      <div class="col-md-6 mx-auto">
        <!-- Search bar with view toggle -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <input type="text" id="productSearch" class="form-control" placeholder="ðŸ”Ž Search products..." onkeyup="searchProducts()">
  
  <!-- âœ… NEW: View Mode Toggle -->
  <div class="btn-group ms-3" role="group">
    <button type="button" class="btn btn-outline-secondary btn-sm active" id="btnAllView" onclick="showAllProducts()">
      <i class="bi bi-list"></i> All
    </button>
    <button type="button" class="btn btn-outline-primary btn-sm" id="btnPhotoView" onclick="showPhotoProducts()">
      <i class="bi bi-images"></i> Photos
    </button>
  </div>
</div>

<!-- âœ… NEW: Photo Product Grid (Hidden by default) -->
<div id="photoProductGrid" style="display:none;" class="row row-cols-1 row-cols-md-3 g-4 mb-4">
  <!-- Photo product cards will be dynamically inserted here -->
</div>

      </div>
    </div>

    <!-- Products table (desktop) & mobile list -->
    <div class="row mb-4">
      <div class="col-12 desktop-table">
        <div class="table-explorer">
          <table class="table table-sm table-striped mb-0">
            <thead><tr><th style="width:50px">Icon</th><th>Photo</th><th>Product</th><th>Category</th><th>Brand</th><th>Size</th><th style="width:120px">Stock</th><th style="width:140px">Price</th><th style="width:150px">Actions</th></tr></thead>
            <tbody id="productsTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="col-12 mobile-list" id="mobileProductsList" style="margin-top:6px;"></div>
    </div>

  <!-- Recent Sales -->
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Recent Sales</h4>
            <button class="btn btn-outline-danger btn-sm" onclick="openClearSalesPopup()">
                <i class="bi bi-trash"></i> Clear Sales
            </button>
        </div>
        <div class="table-responsive">

          <table class="table table-striped">
            <thead class="table-primary"><tr><th>Date & Time</th><th>Product</th><th>Quantity</th><th>Unit</th><th>Amount</th></tr></thead>
            <tbody id="salesList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!--  Sales Modal -->
<div class="modal fade" id="clearSalesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Clear Sales History</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Clear sales records between specific dates:</p>
                
                <div class="mb-3">
                    <label class="form-label">From Date:</label>
                    <input type="date" class="form-control" id="clearFromDate" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">To Date:</label>
                    <input type="date" class="form-control" id="clearToDate" required>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Note:</strong> This will clear sales from display only. 
                    Google Sheets data remains unchanged.
                </div>
                
                <div id="clearSalesCount" class="alert alert-info" style="display: none;">
                    <i class="bi bi-info-circle"></i>
                    Found <strong id="salesCountNumber">0</strong> sales records in this date range.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="clearSalesInDateRange()">
                    <i class="bi bi-trash"></i> Clear Sales
                </button>
            </div>
        </div>
    </div>
</div>


  <!-- INVOICE MODAL -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-receipt"></i> Create Invoice
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="invoiceForm">
          
          <!-- Customer Name -->
          <div class="mb-3">
            <label class="form-label">Customer Name *</label>
            <input type="text" class="form-control" id="invoiceCustomerName" 
                   required placeholder="Enter customer name">
          </div>
          
          <!-- Invoice Details Row -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Invoice Number *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="invoiceNumber" required readonly>
                <button class="btn btn-outline-secondary" type="button" 
                        onclick="regenerateInvoiceNumber()" title="Regenerate">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Invoice Date *</label>
              <input type="date" class="form-control" id="invoiceDate" required>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Payment Terms</label>
              <select class="form-select" id="paymentTerms" onchange="calculateDueDate()">
                <option value="0">Due on Receipt</option>
                <option value="7">Net 7</option>
                <option value="15" selected>Net 15</option>
                <option value="30">Net 30</option>
                <option value="45">Net 45</option>
                <option value="60">Net 60</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-control" id="invoiceDueDate">
            </div>
          </div>
          
          <!-- Items Table -->
          <div class="mb-3">
            <h6 class="border-bottom pb-2">Invoice Items</h6>
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead class="table-light">
                  <tr>
                    <th style="width: 40%">Item Details</th>
                    <th style="width: 12%" class="text-center">Quantity</th>
                    <th style="width: 15%" class="text-end">Rate (Ã¢â€šÂ¹)</th>
                    <th style="width: 18%" class="text-end">Amount (Ã¢â€šÂ¹)</th>
                    <th style="width: 5%"></th>
                  </tr>
                </thead>
                <tbody id="invoiceItemsBody">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addInvoiceRow()">
              <i class="bi bi-plus-circle"></i> Add Row
            </button>
          </div>
          
          <!-- Totals Section -->
          <div class="row">
            <div class="col-md-6"></div>
            <div class="col-md-6">
              <table class="table table-sm">
                <tr>
                  <td class="text-end"><strong>Sub Total:</strong></td>
                  <td class="text-end" style="width: 150px" id="invoiceSubtotal">Ã¢â€šÂ¹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    <span class="me-2">Discount:</span>
                    <input type="number" class="form-control form-control-sm d-inline-block" 
                           style="width: 70px" id="invoiceDiscount" value="0" min="0" 
                           oninput="calculateInvoiceTotal()">
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 60px" id="invoiceDiscountType" 
                            onchange="calculateInvoiceTotal()">
                      <option value="amount">Ã¢â€šÂ¹</option>
                      <option value="percent">%</option>
                    </select>
                  </td>
                  <td class="text-end text-danger" id="invoiceDiscountAmount">-Ã¢â€šÂ¹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    <span class="me-2">Tax (GST):</span>
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 90px" id="invoiceTaxRate" 
                            onchange="calculateInvoiceTotal()">
                      <option value="0">No Tax</option>
                      <option value="5">5%</option>
                      <option value="12">12%</option>
                      <option value="18" selected>18%</option>
                      <option value="28">28%</option>
                    </select>
                  </td>
                  <td class="text-end" id="invoiceTaxAmount">Ã¢â€šÂ¹0.00</td>
                </tr>
                <tr class="table-success fw-bold">
                  <td class="text-end"><h5 class="mb-0">Total (Ã¢â€šÂ¹):</h5></td>
                  <td class="text-end"><h5 class="mb-0" id="invoiceGrandTotal">Ã¢â€šÂ¹0.00</h5></td>
                </tr>
              </table>
            </div>
          </div>
          
          <!-- Customer Notes -->
          <div class="mb-3">
            <label class="form-label">Customer Notes</label>
            <textarea class="form-control" id="invoiceNotes" rows="2" 
                      placeholder="Add notes for customer (e.g., delivery instructions, thank you message)">Thanks for your business.</textarea>
            <small class="text-muted">Optional message to include on the invoice</small>
          </div>
          
          <!-- Terms & Conditions -->
          <div class="mb-3">
            <label class="form-label">
              Terms & Conditions
              <button type="button" class="btn btn-sm btn-link p-0" onclick="loadDefaultTerms()">
                <i class="bi bi-arrow-clockwise"></i> Use Default
              </button>
            </label>
            <textarea class="form-control" id="invoiceTerms" rows="4" 
                      placeholder="Enter payment terms and conditions"></textarea>
          </div>
          
        </form>
      </div>
      
      <div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
    <i class="bi bi-x-circle"></i> Close
  </button>
  <button type="button" class="btn btn-info" onclick="previewInvoice()">
    <i class="bi bi-eye"></i> Preview
  </button>
  
  <!-- âœ… FIXED: Share Invoice Dropdown with proper attributes -->
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-primary dropdown-toggle" 
            data-bs-toggle="dropdown" 
            aria-expanded="false">
      <i class="bi bi-share"></i> Share Invoice
    </button>
    <ul class="dropdown-menu">
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareInvoiceAsImage()">
          <i class="bi bi-image"></i> Share as Image (Recommended)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareInvoiceAsPDF()">
          <i class="bi bi-file-pdf"></i> Share as PDF
        </a>
      </li>
      <li><hr class="dropdown-divider"></li>

 <!-- âœ… NEW: Share image on specific WhatsApp number -->
  <li>
    <a class="dropdown-item" href="javascript:void(0);" onclick="shareImageToWhatsAppNumber()">
      <i class="bi bi-whatsapp text-success"></i> Share Image on WhatsApp
    </a>
  </li>
      
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareViaWhatsApp()">
          <i class="bi bi-whatsapp text-success"></i> WhatsApp (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareViaEmail()">
          <i class="bi bi-envelope"></i> Email (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareViaSMS()">
          <i class="bi bi-phone"></i> SMS (Text)
        </a>
      </li>
    </ul>
  </div>
  
  <button type="button" class="btn btn-success" onclick="saveInvoice()">
    <i class="bi bi-save"></i> Save Invoice
  </button>
</div>
      
    </div>
  </div>
</div>

<!-- VIEW INVOICES MODAL -->
<div class="modal fade" id="viewInvoicesModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-receipt-cutoff"></i> Saved Invoices
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <div id="invoicesListContainer">
          <!-- Populated by JavaScript -->
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>




  <!-- Add/Edit Product Modal (image removed) -->
  <div class="modal fade" id="productModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header bg-primary text-white"><h5 id="modalTitle" class="modal-title">Add New Product</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="productForm">
        <input type="hidden" id="productId">
        <div class="row mb-3">
          <div class="col-md-8"><label class="form-label">Product Name *</label><input id="productName" class="form-control" required/></div>
          <div class="col-md-4"><label class="form-label">Category *</label><select id="category" class="form-select" required><option value="">Select</option><option value="Tiles">Tiles</option><option value="Sanitaryware">Sanitaryware</option><option value="Accessories">Accessories</option></select></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><label class="form-label">Brand</label><input id="brand" class="form-control"/></div>
          <div class="col-md-6"><label class="form-label">Size</label><input id="size" class="form-control" placeholder="e.g., 2x2 feet or Standard"/></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4"><label class="form-label">Unit Type *</label><select id="unitType" class="form-select" required><option value="Box">Box</option><option value="Piece">Piece</option><option value="SFT">Square Feet</option></select></div>
          <div class="col-md-4"><label class="form-label">Pieces per Box</label><input id="piecesPerBox" class="form-control" type="number" value="1"/></div>
          <div class="col-md-4"><label class="form-label">SFT per Box</label><input id="sftPerBox" class="form-control" type="number" step="0.01"/></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4"><label class="form-label">Price per Unit *</label><input id="price" class="form-control" type="number" step="0.01" required/></div>
          <div class="col-md-4"><label class="form-label">Current Stock *</label><input id="stock" class="form-control" type="number" required/></div>
          <div class="col-md-4"><label class="form-label">Minimum Stock</label><input id="minStock" class="form-control" type="number" value="5"/></div>
        </div>
      </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" onclick="saveProduct()">Save Product</button></div>
  </div></div></div>

  <!-- SALES MODAL (grid) - top buttons removed, kept within body below grid -->
  <div class="modal fade" id="salesModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content">
    <div class="modal-header bg-info text-white">
      <h5 class="modal-title">Record New Sale</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>

    <div class="modal-body">

      <!-- ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Multi-Select Product Picker -->
  <div class="mb-3">
    <label class="form-label fw-bold">
      <i class="bi bi-lightning-charge-fill text-warning"></i> Quick Add Products (Multi-Select)
    </label>
    <div class="multi-select-dropdown">
      <button type="button" class="form-control text-start multi-select-toggle" id="multiSelectToggle" onclick="toggleMultiSelect()">
        <span id="multiSelectLabel">Click to select multiple products...</span>
        <i class="bi bi-chevron-down float-end"></i>
      </button>
      <div class="multi-select-options" id="multiSelectOptions">
        <input type="text" class="form-control form-control-sm mb-2" 
               placeholder="ÃƒÂ°Ã…Â¸Ã¢â‚¬ÂÃ‚Â Search products..." 
               id="multiSelectSearch" 
               oninput="filterMultiSelectOptions()">
        <div class="multi-select-list" id="multiSelectList">
          <!-- Checkboxes populated by JS -->
        </div>
      </div>
    </div>
    <small class="text-muted">Select multiple products to auto-fill rows below</small>
  </div>



      
      <!-- ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Buttons at TOP -->
  <div class="mb-3 text-end">
    <button class="btn btn-outline-primary btn-sm me-2" onclick="addMoreRows()">
      <i class="bi bi-plus-circle"></i> Add More Rows
    </button>
    <button class="btn btn-outline-success btn-sm" onclick="openCustomProductPopup()">
      <i class="bi bi-pencil-square"></i> Add Custom Product
    </button>
  </div>
      <div class="table-responsive">
        <table class="table table-sm grid-table mb-0">
          <thead><tr><th class="grid-row-number">#</th><th>Product Name</th><th style="width:130px">Size</th><th style="width:90px">Qty</th><th style="width:110px">Unit</th><th style="width:120px">Price</th><th style="width:140px">Total</th><th style="width:60px"></th></tr></thead>
          <tbody id="product-grid-body"></tbody>
        </table>
      </div>

      <!-- Keep Add buttons only here (below grid) -->
      <div class="mt-3 d-flex justify-content-between align-items-center">
        <div>
          <button class="btn btn-outline-primary btn-sm" onclick="addMoreRows()"><i class="bi bi-plus-circle"></i> Add More Rows</button>
          <button class="btn btn-outline-success btn-sm ms-2" onclick="openCustomProductPopup()"><i class="bi bi-pencil-square"></i> Add Custom Product</button>
        </div>
        <div class="text-end" style="min-width:320px;">
          <table class="table table-borderless mb-0">
            <tr><td class="text-end small-muted"><strong>Subtotal:</strong></td><td id="subtotal" class="text-end">Ã¢â€šÂ¹0.00</td></tr>
            <tr style="font-size:1.25rem;color:#28a745"><td class="text-end"><strong>GRAND TOTAL:</strong></td><td id="grandTotal" class="text-end">Ã¢â€šÂ¹0.00</td></tr>
          </table>
        </div>
      </div>
    </div>

   <div class="modal-footer">
  <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
  <button class="btn btn-info" onclick="generateInvoice()">
    <i class="bi bi-receipt"></i> Generate Invoice
  </button>
  <button class="btn btn-success" onclick="completeSale()">Complete Sale</button>
</div>

  </div></div></div>

  <!-- CUSTOM PRODUCT MODAL (NEW fields) -->
  <div class="modal fade" id="customProductModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Add Custom Product</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="customProductForm">
        <div class="mb-3"><label class="form-label">Product Name *</label><input id="customName" class="form-control" required/></div>
        <div class="mb-3"><label class="form-label">Size</label><input id="customSize" class="form-control" placeholder="e.g., 3x3 feet or Standard"/></div>
        <div class="row">
        
          <div class="col-md-6 mb-3"><label class="form-label">Unit Type *</label><select id="customUnit" class="form-select"><option>Box</option><option>Piece</option><option>SFT</option></select></div>
        </div>
        <div class="mb-3"><label class="form-label">Unit Price *</label><input id="customPrice" type="number" class="form-control" min="0.01" step="0.01" value="0"/></div>
         <div class="col-md-6 mb-3"><label class="form-label">Quantity (for this sale) *</label><input id="customQty" type="number" class="form-control" min="1" value="1"/></div>


        <div class="mb-3"><label class="form-label">Total</label><div id="customTotal" class="fw-bold">Ã¢â€šÂ¹0.00</div></div>
      </form>
    </div>

<!-- INVOICE MODAL -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Create Invoice</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="invoiceForm">
          
          <!-- Customer Name -->
          <div class="mb-3">
            <label class="form-label">Customer Name *</label>
            <input type="text" class="form-control" id="invoiceCustomerName" required placeholder="Enter customer name">
          </div>
          
          <!-- Invoice Details Row -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Invoice Number *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="invoiceNumber" required readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="regenerateInvoiceNumber()" title="Regenerate">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Invoice Date *</label>
              <input type="date" class="form-control" id="invoiceDate" required>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Payment Terms</label>
              <select class="form-select" id="paymentTerms" onchange="calculateDueDate()">
                <option value="0">Due on Receipt</option>
                <option value="7">Net 7</option>
                <option value="15" selected>Net 15</option>
                <option value="30">Net 30</option>
                <option value="45">Net 45</option>
                <option value="60">Net 60</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-control" id="invoiceDueDate">
            </div>
          </div>
          
          <!-- Items Table -->
          <div class="mb-3">
            <h6>Invoice Items</h6>
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead class="table-light">
                  <tr>
                    <th style="width: 40%">Item Details</th>
                    <th style="width: 15%">Quantity</th>
                    <th style="width: 15%">Rate</th>
                    <th style="width: 20%">Amount</th>
                    <th style="width: 10%"></th>
                  </tr>
                </thead>
                <tbody id="invoiceItemsBody">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addInvoiceRow()">
              <i class="bi bi-plus-circle"></i> Add Row
            </button>
          </div>
          
          <!-- Totals Section -->
          <div class="row">
            <div class="col-md-7"></div>
            <div class="col-md-5">
              <table class="table table-sm">
                <tr>
                  <td class="text-end"><strong>Sub Total:</strong></td>
                  <td class="text-end" id="invoiceSubtotal">Ã¢â€šÂ¹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    Discount:
                    <input type="number" class="form-control form-control-sm d-inline-block" 
                           style="width: 80px" id="invoiceDiscount" value="0" min="0" 
                           oninput="calculateInvoiceTotal()">
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 60px" id="invoiceDiscountType" 
                            onchange="calculateInvoiceTotal()">
                      <option value="amount">Ã¢â€šÂ¹</option>
                      <option value="percent">%</option>
                    </select>
                  </td>
                  <td class="text-end text-danger" id="invoiceDiscountAmount">-Ã¢â€šÂ¹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    Tax:
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 100px" id="invoiceTaxRate" 
                            onchange="calculateInvoiceTotal()">
                      <option value="0">No Tax</option>
                      <option value="5">GST 5%</option>
                      <option value="12">GST 12%</option>
                      <option value="18" selected>GST 18%</option>
                      <option value="28">GST 28%</option>
                    </select>
                  </td>
                  <td class="text-end" id="invoiceTaxAmount">Ã¢â€šÂ¹0.00</td>
                </tr>
                <tr class="table-success">
                  <td class="text-end"><h5>Total (Ã¢â€šÂ¹):</h5></td>
                  <td class="text-end"><h5 id="invoiceGrandTotal">Ã¢â€šÂ¹0.00</h5></td>
                </tr>
              </table>
            </div>
          </div>
          
          <!-- Customer Notes -->
          <div class="mb-3">
            <label class="form-label">Customer Notes</label>
            <textarea class="form-control" id="invoiceNotes" rows="2" 
                      placeholder="Add notes for customer...">Thanks for your business.</textarea>
          </div>
          
          <!-- Terms & Conditions -->
          <div class="mb-3">
            <label class="form-label">
              Terms & Conditions
              <button type="button" class="btn btn-sm btn-link" onclick="loadDefaultTerms()">Use Default</button>
            </label>
            <textarea class="form-control" id="invoiceTerms" rows="3" 
                      placeholder="Enter terms and conditions"></textarea>
          </div>
          
        </form>
      </div>
      
      <div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
    <i class="bi bi-x-circle"></i> Close
  </button>
  <button type="button" class="btn btn-info" onclick="previewInvoice()">
    <i class="bi bi-eye"></i> Preview
  </button>
  
  <!-- âœ… NEW: Share Invoice Dropdown -->
  <div class="btn-group">
    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
      <i class="bi bi-share"></i> Share Invoice
    </button>
    <ul class="dropdown-menu">
      <li>
        <a class="dropdown-item" href="#" onclick="shareInvoiceAsImage(); return false;">
          <i class="bi bi-image"></i> Share as Image (Recommended)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareInvoiceAsPDF(); return false;">
          <i class="bi bi-file-pdf"></i> Share as PDF
        </a>
      </li>
      <li><hr class="dropdown-divider"></li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaWhatsApp(); return false;">
          <i class="bi bi-whatsapp text-success"></i> WhatsApp (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaEmail(); return false;">
          <i class="bi bi-envelope"></i> Email (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaSMS(); return false;">
          <i class="bi bi-phone"></i> SMS (Text)
        </a>
      </li>
    </ul>
  </div>
  
  <button type="button" class="btn btn-success" onclick="saveInvoice()">
    <i class="bi bi-save"></i> Save Invoice
  </button>
</div>

      
    </div>
  </div>
</div>

    
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button class="btn btn-success" onclick="addCustomProductToGrid()">Add to Sale</button>
    </div>
  </div></div></div>


  

  <!-- Hidden file input for import -->
  <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileImport(event)">



    <!-- âœ… NEW: Photo Product Modal -->
<div class="modal fade" id="photoProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ðŸ“· Add Product by Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        
        <!-- Photo Upload Area -->
        <div class="upload-area" id="photoUploadArea" onclick="document.getElementById('photoFileInput').click()">
          <div class="upload-icon">ðŸ“·</div>
          <div class="upload-text">Click to take photo or select from gallery</div>
        </div>
        
        <!-- Hidden file inputs -->
        <input type="file" id="photoFileInput" accept="image/*" style="display:none" onchange="handlePhotoSelect(event)">
        <input type="file" id="photoCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handlePhotoSelect(event)">
        
        <!-- Photo Preview -->
        <div id="photoPreviewContainer" class="preview-container">
          <img id="photoPreviewImage" class="preview-image" alt="Product Photo">
          <button type="button" class="btn btn-sm btn-warning" onclick="clearPhotoSelection()">Change Photo</button>
        </div>
        
        <!-- Loading Spinner -->
        <div id="photoLoadingSpinner" class="loading-spinner">
          <div class="spinner"></div>
          <p>Uploading photo...</p>
        </div>
        
        <!-- Product Details Form -->
        <div class="mb-3">
          <label class="form-label">Product Name <span class="text-danger">*</span></label>
          <input type="text" id="photoProductName" class="form-control" placeholder="e.g., White Marble Tile" required>
        </div>
        
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label">Brand</label>
            <input type="text" id="photoProductBrand" class="form-control" placeholder="Optional">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label">Size</label>
            <input type="text" id="photoProductSize" class="form-control" placeholder="e.g., 2x2">
          </div>
        </div>
        
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label">Current Stock</label>
            <input type="number" id="photoProductStock" class="form-control" min="0" placeholder="0">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label">Unit Price (â‚¹)</label>
            <input type="number" id="photoProductPrice" class="form-control" min="0" step="0.01" placeholder="0.00">
          </div>
        </div>
        
        <div class="alert alert-info">
          <small><i class="bi bi-info-circle"></i> Only products with stock and price can be sold.</small>
        </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="savePhotoProduct()">
          <i class="bi bi-check-circle"></i> Save Product
        </button>
      </div>
    </div>
  </div>
</div>

<!-- âœ… NEW: View Photo Modal (Enlarged View) -->
<div class="modal fade" id="viewPhotoModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewPhotoModalTitle">Product Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="viewPhotoModalBody">
        <!-- Content will be dynamically loaded -->
      </div>
    </div>
  </div>
</div>


  <script src="s://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>


    
    
  /***********************
   * CONFIG
   ***********************/
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxqKZYFkC5NTUVYV4AmJjcelyceAYMXvH5ehuehflWScWk92M8iLyaEEosMH-uNq0LO/exec'; // <-- replace with your deployed URL
  let cachedProducts = [];
  let cachedSales = [];
    
// ==========================================
// BACKGROUND SAVE QUEUE
// ==========================================

const backgroundSaveQueue = [];
let isProcessingQueue = false;
let backgroundSyncActive = false;

// ==========================================
// EMAIL + PASSWORD AUTHENTICATION (WITH HASH)
// ==========================================

let currentUser = null;
let userEmail = null;
let userHash = null; // Ã¢Å“â€¦ NEW: Store encrypted hash

// Simple hash function (matches backend)
function simpleHash(text) {
  let hash = 0;
  if (text.length === 0) return hash.toString();
  for (let i = 0; i < text.length; i++) {
    const char = text.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(36);
}

// Toggle password visibility
function togglePasswordVisibility() {
  const passwordInput = document.getElementById('userPasswordInput');
  const toggleIcon = document.getElementById('passwordToggleIcon');
  
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggleIcon.className = 'bi bi-eye-slash';
  } else {
    passwordInput.type = 'password';
    toggleIcon.className = 'bi bi-eye';
  }
}

// Check authentication on page load
window.addEventListener('load', async function() {
  console.log('Ã°Å¸Å¡â‚¬ Page loaded, checking authentication...');
  
  // Check localStorage for saved credentials
  const savedEmail = localStorage.getItem('userEmail');
  const savedHash = localStorage.getItem('userHash');
  const savedUser = localStorage.getItem('currentUser');
  
  console.log('Ã°Å¸â€œÂ¦ Checking localStorage:', {
    hasEmail: !!savedEmail,
    hasHash: !!savedHash,
    hasUser: !!savedUser
  });
  
  if (savedEmail && savedHash) {
    console.log('Ã¢Å“â€¦ Found saved credentials, auto-logging in...');
    
    try {
      // Ã¢Å“â€¦ SET VARIABLES FIRST
      userEmail = savedEmail;
      userHash = savedHash;
      
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
      } else {
        currentUser = {
          email: savedEmail,
          name: savedEmail.split('@')[0],
          authorized: true
        };
      }
      
      console.log('Ã¢Å“â€¦ Session restored:', { userEmail, hasHash: !!userHash });
      
      // Ã¢Å“â€¦ Show app IMMEDIATELY
      showApp();
      updateUserUI();
      
      // Ã¢Å“â€¦ Wait before syncing
      setTimeout(async () => {
        console.log('Ã°Å¸â€â€ž Starting data sync...');
        await syncFromGoogleSheets();
      }, 500);
      
    } catch (error) {
      console.error('Ã¢ÂÅ’ Error restoring session:', error);
      showAuthScreen();
    }
  } else {
    console.log('Ã°Å¸â€˜Â¤ No saved credentials, showing login screen...');
    showAuthScreen();
  }
});

// Handle email + password authentication
async function handleEmailPasswordAuth(event) {
  event.preventDefault();
  
  const emailInput = document.getElementById('userEmailInput');
  const passwordInput = document.getElementById('userPasswordInput');
  const loginButton = document.getElementById('loginButton');
  
  const email = emailInput.value.trim().toLowerCase();
  const password = passwordInput.value;
  
  if (!email || !password) {
    alert('Please enter both email and password');
    return;
  }
  
  console.log('Ã°Å¸â€Â Authenticating:', email);
  
  // Show loading state
  const originalText = loginButton.innerHTML;
  loginButton.disabled = true;
  loginButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
  
  try {
    // Ã¢Å“â€¦ Send email + password to backend
    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=authenticate&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
      method: 'POST'
    });
    
    const data = await response.json();
    
    if (data.ok && data.user && data.hash) {
      // Ã¢Å“â€¦ SUCCESS - Save email + hash
      userEmail = email;
      userHash = data.hash;
      currentUser = data.user;
      
      // Ã¢Å“â€¦ Save to localStorage for permanent login
      localStorage.setItem('userEmail', email);
      localStorage.setItem('userHash', data.hash);
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      
      console.log('Ã¢Å“â€¦ Authentication successful');
      console.log('Ã¢Å“â€¦ Hash saved to localStorage');
      
      // Clear password field
      passwordInput.value = '';
      
      // Show app and load data
      showApp();
      updateUserUI();
      
      setTimeout(async () => {
        await syncFromGoogleSheets();
      }, 300);
      
    } else {
      // Ã¢ÂÅ’ FAILED
      console.error('Ã¢ÂÅ’ Authentication failed:', data);
      alert(data.message || 'Invalid email or password');
      loginButton.disabled = false;
      loginButton.innerHTML = originalText;
      passwordInput.value = '';
      passwordInput.focus();
    }
    
  } catch (error) {
    console.error('Ã¢ÂÅ’ Authentication error:', error);
    alert('Failed to authenticate. Please check your internet connection and try again.');
    loginButton.disabled = false;
    loginButton.innerHTML = originalText;
  }
}

// Clear authentication
function clearAuth() {
  console.log('Ã°Å¸â€”â€˜Ã¯Â¸Â Clearing authentication...');
  userEmail = null;
  userHash = null;
  currentUser = null;
  localStorage.removeItem('userEmail');
  localStorage.removeItem('userHash');
  localStorage.removeItem('currentUser');
}

// Show authentication screen
function showAuthScreen() {
  console.log('Ã°Å¸â€œÂ± Showing auth screen');
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('appContent').style.display = 'none';
  
  // Pre-fill email if saved
  const savedEmail = localStorage.getItem('userEmail');
  if (savedEmail) {
    document.getElementById('userEmailInput').value = savedEmail;
    document.getElementById('userPasswordInput').focus();
  }
}

// Show app
function showApp() {
  console.log('Ã°Å¸â€œÂ± Showing app');
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('appContent').style.display = 'block';
}

// Update user UI
function updateUserUI() {
  if (currentUser) {
    const userNameEl = document.getElementById('userName');
    
    if (userNameEl) {
      userNameEl.textContent = currentUser.name || currentUser.email;
      console.log('Ã°Å¸â€˜Â¤ Updated username:', currentUser.email);
    }
  }
}

// Show auth error
function showAuthError(message) {
  console.warn('Ã°Å¸Å¡Â¨ Auth error:', message);
  
  if (message && (message.includes('unauthorized') || message.includes('not authorized') || message.includes('expired'))) {
    clearAuth();
    alert('Ã°Å¸â€â€™ ' + message);
    showAuthScreen();
  } else {
    console.log('Ã¢Å¡ Ã¯Â¸Â Non-critical error, keeping credentials');
  }
}

// Sign out
function signOut() {
  if (confirm('Are you sure you want to sign out?')) {
    console.log('Ã°Å¸â€˜â€¹ Signing out...');
    clearAuth();
    showAuthScreen();
    setTimeout(() => location.reload(), 300);
  }
}

// ==========================================
// CHANGE PASSWORD FUNCTIONALITY
// ==========================================

let changePasswordModalInstance = null;

// Open change password modal
function openChangePasswordModal() {
  console.log('Ã°Å¸â€â€˜ Opening change password modal');
  
  // Reset form
  document.getElementById('verifyPasswordStep').style.display = 'block';
  document.getElementById('newPasswordStep').style.display = 'none';
  document.getElementById('currentPasswordInput').value = '';
  document.getElementById('newPasswordInput').value = '';
  document.getElementById('confirmPasswordInput').value = '';
  
  // Show modal
  const modalEl = document.getElementById('changePasswordModal');
  if (!changePasswordModalInstance) {
    changePasswordModalInstance = new bootstrap.Modal(modalEl);
  }
  changePasswordModalInstance.show();
}

// Verify current password (Step 1)
async function verifyCurrentPassword() {
  const currentPasswordInput = document.getElementById('currentPasswordInput');
  const currentPassword = currentPasswordInput.value;
  
  if (!currentPassword) {
    alert('Please enter your current password');
    return;
  }
  
  console.log('Ã°Å¸â€Â Verifying current password...');
  
  try {
    // Verify by attempting authentication
    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=authenticate&email=${encodeURIComponent(userEmail)}&password=${encodeURIComponent(currentPassword)}`, {
      method: 'POST'
    });
    
    const data = await response.json();
    
    if (data.ok) {
      // Ã¢Å“â€¦ Password correct - show step 2
      console.log('Ã¢Å“â€¦ Current password verified');
      document.getElementById('verifyPasswordStep').style.display = 'none';
      document.getElementById('newPasswordStep').style.display = 'block';
      document.getElementById('newPasswordInput').focus();
    } else {
      // Ã¢ÂÅ’ Wrong password
      alert('Current password is incorrect');
      currentPasswordInput.value = '';
      currentPasswordInput.focus();
    }
    
  } catch (error) {
    console.error('Ã¢ÂÅ’ Error verifying password:', error);
    alert('Failed to verify password. Please try again.');
  }
}

// Submit new password (Step 2)
async function submitNewPassword() {
  const currentPasswordInput = document.getElementById('currentPasswordInput');
  const newPasswordInput = document.getElementById('newPasswordInput');
  const confirmPasswordInput = document.getElementById('confirmPasswordInput');
  
  const oldPassword = currentPasswordInput.value;
  const newPassword = newPasswordInput.value;
  const confirmPassword = confirmPasswordInput.value;
  
  // Validate inputs
  if (!newPassword || !confirmPassword) {
    alert('Please fill in all fields');
    return;
  }
  
  if (newPassword.length < 6) {
    alert('New password must be at least 6 characters');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    alert('Passwords do not match');
    confirmPasswordInput.value = '';
    confirmPasswordInput.focus();
    return;
  }
  
  if (newPassword === oldPassword) {
    alert('New password must be different from current password');
    newPasswordInput.value = '';
    confirmPasswordInput.value = '';
    newPasswordInput.focus();
    return;
  }
  
  console.log('Ã°Å¸â€â€ž Changing password...');
  
  try {
    // Send change password request
    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=changePassword&email=${encodeURIComponent(userEmail)}&oldPassword=${encodeURIComponent(oldPassword)}&newPassword=${encodeURIComponent(newPassword)}`, {
      method: 'POST'
    });
    
    const data = await response.json();
    
    if (data.ok && data.hash) {
      // Ã¢Å“â€¦ SUCCESS - Update hash in localStorage
      userHash = data.hash;
      localStorage.setItem('userHash', data.hash);
      
      console.log('Ã¢Å“â€¦ Password changed successfully');
      console.log('Ã¢Å“â€¦ New hash saved');
      
      // Close modal
      changePasswordModalInstance.hide();
      
      // Show success message
      alert('Ã¢Å“â€¦ Password changed successfully!');
      
    } else {
      // Ã¢ÂÅ’ FAILED
      alert(data.message || 'Failed to change password');
    }
    
  } catch (error) {
    console.error('Ã¢ÂÅ’ Error changing password:', error);
    alert('Failed to change password. Please try again.');
  }
}



let deletedSaleIds = []; // NEW: Track manually deleted sales

// NEW: Load deleted IDs from localStorage on page load
try {
    const stored = localStorage.getItem('deletedSaleIds');
    if (stored) {
        deletedSaleIds = JSON.parse(stored);
        console.log('ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒâ€šÃ‚Â Loaded', deletedSaleIds.length, 'deleted sale IDs from localStorage');
    }
} catch (e) {
    console.warn('Could not load deletedSaleIds from localStorage', e);
}
    
  let hasInitialLoaded = false;

  // Keep custom products added into the current sale (persist across grid re-builds)
  let customProductsInSale = []; // { id, name, size, unitType, price, quantity, isPersistedToInventory:false/true, tempProductId }







  /***********************
   * Helpers
   ***********************/
  function showSyncIndicator(msg='Syncing...', hideAfterMs=null) {
    const el = document.getElementById('syncIndicator');
    document.getElementById('syncText').textContent = msg;
    el.style.display = 'block';
    if (hideAfterMs) setTimeout(()=> el.style.display = 'none', hideAfterMs);
  }
  function hideSyncIndicator(){ document.getElementById('syncIndicator').style.display='none'; }

  function safeParseResponse(res) {
    return res.text().then(txt => {
      try { return { ok: res.ok, json: JSON.parse(txt), text: txt }; }
      catch(e) { return { ok: res.ok, json: null, text: txt }; }
    });
  }
  function formatCurrency(n){ return 'Ã¢â€šÂ¹' + Number(n||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function generateId(){ return 'TMP_' + Date.now().toString(36) + Math.random().toString(36).substr(2); }
  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/**
 * Sync / Fetch from Google Sheets
 * Combines authentication check + complete data fetching + sales filtering
 */
async function syncFromGoogleSheets() {
  if (!userEmail || !userHash) {
    console.warn('Ã¢Å¡ Ã¯Â¸Â No credentials, checking localStorage...');
    const savedEmail = localStorage.getItem('userEmail');
    const savedHash = localStorage.getItem('userHash');
    if (savedEmail && savedHash) {
      userEmail = savedEmail;
      userHash = savedHash;
      console.log('Ã¢Å“â€¦ Restored credentials from localStorage');
    } else {
      console.log('Ã°Å¸â€˜Â¤ No credentials found');
      showAuthScreen();
      return;
    }
  }

  showSyncIndicator('Refreshing...');
  
  try {
    // Ã¢Å“â€¦ Send email + hash for authentication
    const url = `${GOOGLE_SCRIPT_URL}?action=getAll&email=${encodeURIComponent(userEmail)}&hash=${encodeURIComponent(userHash)}&t=${Date.now()}`;

    const res = await fetch(url);
    
    if (!res.ok) {
      throw new Error(`Network error: ${res.status}`);
    }
    
    const data = await res.json();
    
    // Check for unauthorized response
    if (!data.success && data.error === 'unauthorized') {
      // Ã¢Å“â€¦ ONLY clear auth on real unauthorized error
      console.error('Ã¢ÂÅ’ Email not authorized');
      clearAuth();
      alert('Access denied. Your email is not authorized. Please contact administrator.');
      showAuthScreen();
      hideSyncIndicator();
      return;
    }
    
    // Verify successful response
    if (data && data.success) {
      // Update products
      cachedProducts = data.products || [];
      
      // Update sales with filtering for deleted items
      let allSales = data.sales || [];
      
      // Filter out manually deleted sales
      cachedSales = allSales.filter(sale => !deletedSaleIds.includes(sale.id));
      console.log(`Ã°Å¸â€œÅ  Loaded ${allSales.length} sales from server, showing ${cachedSales.length} (${allSales.length - cachedSales.length} deleted)`);
      
      // Sort sales by date (newest first)
      sortSalesByDateDescending();
      
      // Mark initial load complete
      hasInitialLoaded = true;
      
      // Render both products and sales
      renderProducts();
      renderSales();
      
      // Update dashboard metrics
      updateSummaryFromCache();
      
      showSyncIndicator('Synced!', 900);
      
    } else {
      throw new Error(data.error || 'Failed to fetch data');
    }
    
  } catch (err) {
    console.error('Ã¢Å¡ Ã¯Â¸Â Sync error (non-critical):', err);
    // Ã¢Å“â€¦ Don't show alert or clear auth on network errors
    hideSyncIndicator();
  }
}



  async function fallbackGetProductsAndSales() {
    try { const p = await fetch(`${GOOGLE_SCRIPT_URL}?action=getProducts&t=${Date.now()}`); if(p.ok){ const pj=await p.json(); if(pj && pj.products) cachedProducts=pj.products; } }
    catch(e){ console.warn('fallback products failed', e); }
    try { const s = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSales&t=${Date.now()}`); if(s.ok){ const sj=await s.json(); if(sj && sj.sales) cachedSales=sj.sales; } }
    catch(e){ console.warn('fallback sales failed', e); }
    hasInitialLoaded = true; renderProducts(); renderSales();
  }
  async function manualRefresh(){ const btn = document.getElementById('refreshBtn'); const icon=document.getElementById('refreshIcon'); btn.disabled=true; icon.className='bi bi-arrow-clockwise spinner-border spinner-border-sm'; await syncFromGoogleSheets(); icon.className='bi bi-arrow-clockwise'; btn.disabled=false; }

  /***********************
   * Rendering
   ***********************/
  function categoryIconColor(cat){
    if(!cat) return '#6c757d';
    const c = cat.toLowerCase();
    if(c.includes('tile')) return '#0d6efd';
    if(c.includes('sanitary')) return '#198754';
    if(c.includes('access')) return '#fd7e14';
    return '#6c757d';
  }

  function stockBadgeHtml(stock, minStock){
    minStock = (typeof minStock === 'number') ? minStock : Number(minStock)||5;
    stock = Number(stock)||0;
    if(stock === 0) return `<span class="stock-badge bg-danger text-white">Out of Stock</span>`;
    if(stock <= minStock) return `<span class="stock-badge bg-warning text-dark">Low (${stock})</span>`;
    return `<span class="stock-badge bg-success text-white">In Stock (${stock})</span>`;
  }

  function renderProducts(){
    const tbody = document.getElementById('productsTableBody');
    if(!hasInitialLoaded){
      tbody.innerHTML = `<tr><td colspan="9" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventoryÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¦</div></td></tr>`;
    } else if(!cachedProducts || cachedProducts.length===0){
      tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No products yet</td></tr>`;
    } else {
      let html = '';
      cachedProducts.forEach(p => {
        const iconColor = categoryIconColor(p.category);
        const priceText = (p.price!==undefined && p.price!==null) ? `Ã¢â€šÂ¹${parseFloat(p.price).toFixed(2)}/${p.unitType}` : '-';
        html += `<tr>
          <td><i class="bi bi-file-earmark-fill" style="color:${iconColor}"></i></td>   
<!-- âœ… Photo Thumbnail Column -->
  <td style="text-align: center;">
    ${p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...' ? 
      `<img src="${p.imageUrl}" 
           class="photo-thumbnail-small" 
           alt="Photo" 
           onclick="viewPhotoProduct('${p.id}')"
           style="cursor:pointer; width:40px; height:40px; object-fit:cover; border-radius:4px; border:2px solid #e0e0e0;"
           onerror="this.onerror=null; this.src='https://via.placeholder.com/40?text=No+Img'; console.error('Image load failed for product: ${escapeHtml(p.name)}');">` : 
      `<i class="bi bi-image text-muted"></i>`}
  </td>
          
          <td>${escapeHtml(p.name)}</td>
          <td>${escapeHtml(p.category||'')}</td>
          <td>${escapeHtml(p.brand||'')}</td>
          <td><strong>${escapeHtml(p.size||'')}</strong></td>
          <td>${stockBadgeHtml(p.stock,p.minStock)}</td>
          <td>${priceText}</td>
          <td>
            <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')"><i class="bi bi-pencil"></i> Edit</button>
            <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')"><i class="bi bi-trash"></i> Delete</button>
          </td>
        </tr>`;
      });
      tbody.innerHTML = html;
    }
    // mobile list
    const container = document.getElementById('mobileProductsList');
    if(!hasInitialLoaded){ container.innerHTML=`<div class="mobile-item text-center"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventoryÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¦</div></div>`; }
    else if(!cachedProducts || cachedProducts.length===0){ container.innerHTML=`<div class="mobile-item text-center text-muted">No products yet</div>`; }
    else {
      let html = '';
      cachedProducts.forEach(p => {
        const iconColor = categoryIconColor(p.category);
        html += `<div class="mobile-item d-flex align-items-start justify-content-between">
          <div style="display:flex;gap:.8rem;align-items:center;">
            <div style="width:36px;text-align:center;"><i class="bi bi-file-earmark-fill" style="font-size:1.25rem;color:${iconColor}"></i></div>
            <div>
              <div style="font-weight:600">${escapeHtml(p.name)}</div>
              <div class="small-muted">${escapeHtml(p.category||'')} ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¢ ${escapeHtml(p.brand||'')}</div>
              <div class="small-muted"><strong>${escapeHtml(p.size||'')}</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¢ Ã¢â€šÂ¹${parseFloat(p.price||0).toFixed(2)}/${p.unitType}</div>
            </div>
          </div>
          <div style="text-align:right;">
            <div>${stockBadgeHtml(p.stock,p.minStock)}</div>
            <div style="margin-top:.5rem">
              <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        </div>`;
      });
      container.innerHTML = html;
    }
    updateSummaryFromCache();
    loadProductsForSaleFromCache();
  }

  function renderSales(){
    const tbody = document.getElementById('salesList');
    
    if(!hasInitialLoaded){ tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading salesÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¦</div></td></tr>`; return; }
    
    if(!cachedSales || cachedSales.length===0){ tbody.innerHTML=`<tr><td colspan="5" class="text-center text-muted py-4">No sales recorded yet</td></tr>`; return; }
    
    let html = '';
    
    const recent = (cachedSales || []).slice(0,100);
    recent.forEach(sale => {
      const d = new Date(sale.date||'');
      const formatted = d && !isNaN(d) ? (d.toLocaleDateString('en-IN') + ' ' + d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})) : sale.date;
      html += `<tr><td>${formatted}</td><td>${escapeHtml(sale.productName)}</td><td>${sale.quantity}</td><td>${escapeHtml(sale.unitType)}</td><td class="text-success fw-bold">Ã¢â€šÂ¹${parseFloat(sale.totalAmount||0).toFixed(2)}</td></tr>`;
    });
    tbody.innerHTML = html;
    updateSummaryFromCache();
  }

  function updateSummaryFromCache(){
    if(!hasInitialLoaded){ document.getElementById('totalProducts').textContent='Loading...'; document.getElementById('salesToday').textContent='Loading...'; document.getElementById('lowStock').textContent='Loading...'; return; }
    document.getElementById('totalProducts').textContent = (cachedProducts||[]).length;
    const today = new Date().toDateString();
    const todaySales = (cachedSales||[]).filter(s => new Date(s.date).toDateString() === today);
    const sum = todaySales.reduce((acc,s) => acc + parseFloat(s.totalAmount||0), 0);
    document.getElementById('salesToday').textContent = 'Ã¢â€šÂ¹' + sum.toFixed(2);
    const low = (cachedProducts||[]).filter(p => p.stock <= p.minStock && p.stock > 0).length;
    document.getElementById('lowStock').textContent = low;
  }

  /***********************
   * Utility: build product selects including custom in-sale items
   ***********************/
  function populateProductSelectForRow(rowIndex){
    const sel = document.getElementById(`product-${rowIndex}`);
    if(!sel) return;
    const current = sel.value;
    sel.innerHTML = `<option value="">-- Select Product --</option>`;
    // Add cachedProducts first
    (cachedProducts || []).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.dataset.size = p.size || '';
      opt.dataset.unit = p.unitType || '';
      opt.dataset.price = p.price;
      opt.dataset.stock = p.stock;
      opt.text = `${p.name} (Stock: ${p.stock} ${p.unitType})`;
      sel.appendChild(opt);
    });
    // Add custom in-sale products (those not in cachedProducts yet)
    (customProductsInSale || []).forEach(cp => {
      // If a matching id already exists in cachedProducts skip
      if((cachedProducts||[]).find(p => p.id === cp.tempId)) return;
      const opt = document.createElement('option');
      opt.value = cp.tempId;
      opt.dataset.size = cp.size || '';
      opt.dataset.unit = cp.unitType || '';
      opt.dataset.price = cp.price;
      opt.dataset.stock = cp.quantity; // treat its available stock as sale-qty (or 9999)
      opt.text = `${cp.name} (Custom)`;
      sel.appendChild(opt);
    });
    if(current) sel.value = current;
  }

 /***********************
 * Save helpers (server calls) - safe against CORS preflight + include idToken
 ***********************/
/**
 * Save product to Google Sheets
 */
async function saveProductToSheet(product, isEdit=false) {
  if (!userEmail || !userHash) { 
    showAuthError('Please sign in to save product'); 
    return null; 
  }
  
  try {
    // Ã¢Å“â€¦ Send hash for authentication
    const url = `${GOOGLE_SCRIPT_URL}?action=${isEdit ? 'updateProduct' : 'addProduct'}&email=${encodeURIComponent(userEmail)}&hash=${encodeURIComponent(userHash)}`;

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, // "simple" content-type -> no preflight
      body: JSON.stringify(product)
    });
    const parsed = await safeParseResponse(res);
    
    // Check for unauthorized response
    if (parsed.json && parsed.json.error === 'unauthorized') {
      showAuthError('Your session has expired. Please sign in again.');
      return null;
    }
    
    return parsed.json || null;
  } catch (e) {
    console.error('saveProductToSheet error', e);
    return null;
  }
}


/**
 * Save sale to Google Sheets
 */
async function saveSaleToSheet(item) {
  if (!userEmail || !userHash) { 
    showAuthError('Please sign in to save sale'); 
    return null; 
  }
  
  try {
    // Ã¢Å“â€¦ Send hash for authentication
    const url = `${GOOGLE_SCRIPT_URL}?action=addSale&email=${encodeURIComponent(userEmail)}&hash=${encodeURIComponent(userHash)}`;

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, // avoid preflight
      body: JSON.stringify(item)
    });
    const parsed = await safeParseResponse(res);
    
    // Check for unauthorized response
    if (parsed.json && parsed.json.error === 'unauthorized') {
      showAuthError('Your session has expired. Please sign in again.');
      return null;
    }
    
    return parsed.json || null;
  } catch (e) {
    console.error('saveSaleToSheet error', e);
    return null;
  }
}

    // ==========================================
// HELPER: Delay function
// ==========================================
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ==========================================
// HELPER: Success Toast Notification
// ==========================================
function showSuccessToast(message) {
  // Remove existing toast if any
  const existingToast = document.getElementById('successToast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Create toast element
  const toast = document.createElement('div');
  toast.id = 'successToast';
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 1.5rem;"></i>
      <div><strong>${message}</strong></div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Show toast with animation
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  // Hide and remove after 3 seconds
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (toast && toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// ==========================================
// HELPER: Update sync indicator
// ==========================================
function updateSyncIndicator(active) {
  const indicator = document.getElementById('backgroundSyncStatus');
  if (indicator) {
    indicator.style.display = active ? 'flex' : 'none';
  }
}




  // ==========================================
// BACKGROUND QUEUE PROCESSOR
// ==========================================
async function processBackgroundSaveQueue() {
  if (isProcessingQueue) {
    console.log('Ã¢ÂÂ³ Queue processor already running');
    return;
  }
  
  if (backgroundSaveQueue.length === 0) {
    console.log('Ã¢Å“â€¦ Queue empty, processor stopping');
    backgroundSyncActive = false;
    updateSyncIndicator(false);
    return;
  }
  
  isProcessingQueue = true;
  backgroundSyncActive = true;
  updateSyncIndicator(true);
  
  console.log(`Ã°Å¸â€â€ž Processing ${backgroundSaveQueue.length} items in background queue...`);
  
  while (backgroundSaveQueue.length > 0) {
    const item = backgroundSaveQueue[0]; // Peek at first item
    
    console.log(`Ã°Å¸â€œÂ¤ Background saving: "${item.productName}" (${backgroundSaveQueue.length} remaining)`);
    
    // Try to save with retry logic
    let saved = false;
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        const response = await saveSaleToSheet(item);
        
        if (response && response.success) {
          console.log(`Ã¢Å“â€¦ Background saved: "${item.productName}"`);
          saved = true;
          break;
        }
        
        // If not last attempt, wait before retry
        if (attempt < 3) {
          console.log(`Ã¢Å¡ Ã¯Â¸Â Retry ${attempt}/3 for "${item.productName}" in ${attempt}s...`);
          await delay(1000 * attempt); // 1s, 2s backoff
        }
        
      } catch (error) {
        console.error(`Ã¢ÂÅ’ Attempt ${attempt}/3 failed for "${item.productName}":`, error);
        
        if (attempt < 3) {
          await delay(1000 * attempt);
        }
      }
    }
    
    if (saved) {
      // Successfully saved - remove from queue
      backgroundSaveQueue.shift();
    } else {
      // Failed after 3 retries - log error and remove
      console.error(`Ã¢ÂÅ’ PERMANENT FAILURE: Could not save "${item.productName}" after 3 attempts`);
      console.error('Failed item data:', item);
      
      // Remove from queue to prevent infinite loop
      backgroundSaveQueue.shift();
      
      // Optional: Store in localStorage for manual recovery
      try {
        const failedItems = JSON.parse(localStorage.getItem('failedSales') || '[]');
        failedItems.push({
          item: item,
          timestamp: new Date().toISOString(),
          error: 'Max retries exceeded'
        });
        localStorage.setItem('failedSales', JSON.stringify(failedItems));
        console.log('Ã°Å¸â€™Â¾ Failed item saved to localStorage for recovery');
      } catch (e) {
        console.error('Could not save to localStorage:', e);
      }
    }
    
    // Ã¢Å“â€¦ CRITICAL: Delay between items to prevent throttling
    if (backgroundSaveQueue.length > 0) {
      await delay(500); // 500ms delay between saves
    }
  }
  
  isProcessingQueue = false;
  backgroundSyncActive = false;
  updateSyncIndicator(false);
  
  console.log('Ã¢Å“â€¦ Background queue processing complete!');
  
  // Optional: Silent background sync after all saves complete
  setTimeout(() => {
    console.log('Ã°Å¸â€â€ž Starting background sync from Google Sheets...');
    syncFromGoogleSheets();
  }, 2000);
}


// Helper: Delay function
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Helper: Update sync indicator
function updateSyncIndicator(active) {
  const indicator = document.getElementById('backgroundSyncStatus');
  if (indicator) {
    indicator.style.display = active ? 'block' : 'none';
  }
}


/**
 * Delete product from Google Sheets
 */
async function deleteProductFromSheet(id) {
  if (!userEmail || !userHash) { 
    showAuthError('Please sign in to delete product'); 
    return false; 
  }
  
  try {
    // Ã¢Å“â€¦ Send hash for authentication
    const url = `${GOOGLE_SCRIPT_URL}?action=deleteProduct&email=${encodeURIComponent(userEmail)}&hash=${encodeURIComponent(userHash)}`;

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, // avoid preflight
      body: JSON.stringify({ id })
    });
    const parsed = await safeParseResponse(res);
    
    // Check for unauthorized response
    if (parsed.json && parsed.json.error === 'unauthorized') {
      showAuthError('Your session has expired. Please sign in again.');
      return false;
    }
    
    return parsed.json && parsed.json.success;
  } catch (e) {
    console.error('deleteProductFromSheet error', e);
    return false;
  }
}



  /***********************
   * Product CRUD UI
   ***********************/
  let editingProductId = null;
  function showAddProduct(){ editingProductId=null; document.getElementById('modalTitle').textContent='Add New Product'; document.getElementById('productForm').reset(); document.getElementById('productId').value=''; new bootstrap.Modal(document.getElementById('productModal')).show(); }
  function editProduct(id){
    const p = (cachedProducts||[]).find(x=>x.id===id);
    if(!p){ alert('ÃƒÂ¢Ã‚ÂÃ…â€™ Product not found'); return; }
    editingProductId = id;
    document.getElementById('modalTitle').textContent='Edit Product';
    document.getElementById('productId').value = p.id;
    document.getElementById('productName').value = p.name;
    document.getElementById('category').value = p.category;
    document.getElementById('brand').value = p.brand||'';
    document.getElementById('size').value = p.size||'';
    document.getElementById('unitType').value = p.unitType;
    document.getElementById('piecesPerBox').value = p.piecesPerBox||1;
    document.getElementById('sftPerBox').value = p.sftPerBox||'';
    document.getElementById('price').value = p.price;
    document.getElementById('stock').value = p.stock;
    document.getElementById('minStock').value = p.minStock;

  // âœ… CRITICAL: Preserve imageUrl when editing
  // Store it in a hidden field or variable
  window.editingProductImageUrl = p.imageUrl || '';
    
    new bootstrap.Modal(document.getElementById('productModal')).show();
  }

 async function saveProduct() {
  const name = document.getElementById('productName').value.trim();
  const category = document.getElementById('category').value;
  const brand = document.getElementById('brand').value.trim();
  const size = document.getElementById('size').value.trim();
  const unitType = document.getElementById('unitType').value;
  const piecesPerBox = parseInt(document.getElementById('piecesPerBox').value) || 1;
  const sftPerBox = parseFloat(document.getElementById('sftPerBox').value) || 0;
  const price = parseFloat(document.getElementById('price').value);
  const stock = parseInt(document.getElementById('stock').value);
  const minStock = parseInt(document.getElementById('minStock').value) || 5;
  
  if (!name || !category || isNaN(price) || isNaN(stock) || stock < 0) {
    alert('Fill required fields');
    return;
  }
  
  const product = {
    id: editingProductId || (Date.now().toString(36) + Math.random().toString(36).substr(2)),
    name: name,
    category: category,
    brand: brand,
    size: size,
    unitType: unitType,
    piecesPerBox: piecesPerBox,
    sftPerBox: sftPerBox,
    price: price,
    stock: stock,
    minStock: minStock,
    imageUrl: window.editingProductImageUrl || ''  // âœ… PRESERVE IMAGE URL
  };
  
  const idx = cachedProducts.findIndex(p => p.id === product.id);
  const previous = idx !== -1 ? Object.assign({}, cachedProducts[idx]) : null;
  
  if (idx !== -1) {
    cachedProducts[idx] = product;
  } else {
    cachedProducts.push(product);
  }
  
  renderProducts();
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
  if (modal) modal.hide();
  
  showSyncIndicator('Saving product...');
  
  // Background save
  saveProductToSheet(product, !!editingProductId).then(resp => {
    if (resp && resp.success) {
      if (resp.id) {
        const localIdx = cachedProducts.findIndex(p => p.id === product.id);
        if (localIdx !== -1) cachedProducts[localIdx].id = resp.id;
        renderProducts();
      }
      showSyncIndicator('Saved', 900);
    }
  }).catch(err => {
    console.error(err);
    if (previous) {
      cachedProducts[idx] = previous;
      renderProducts();
    }
    alert('Save failed - reverted locally.');
  });
  
  // Clear the temporary imageUrl variable
  window.editingProductImageUrl = '';
}

  

  function deleteProduct(id) {
  if (!confirm('Are you sure you want to delete this product?')) {
    return;
  }
  
  const prev = cachedProducts.slice();
  cachedProducts = cachedProducts.filter(p => p.id !== id);
  renderProducts();
  
  // Also update photo grid if currently viewing it
  if (document.getElementById('btnPhotoView').classList.contains('active')) {
    showPhotoProducts();
  }
  
  showSyncIndicator('Deleting...');
  
  deleteProductFromSheet(id).then(success => {
    if (success) {
      showSyncIndicator('Deleted', 900);
    } else {
      cachedProducts = prev;
      renderProducts();
      if (document.getElementById('btnPhotoView').classList.contains('active')) {
        showPhotoProducts();
      }
      alert('Delete failed - reverted locally.');
    }
  });
}


  /***********************
   * SALES GRID: create rows, populate selects, mobile behavior
   ***********************/
  function openSalesModal(){
  initSalesGrid();
  populateMultiSelect(); // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Populate multi-select
  new bootstrap.Modal(document.getElementById('salesModal')).show();
}

// âœ… CORRECTED: Multi-Select Functions with Photo Support
function populateMultiSelect() {
    const container = document.getElementById('multiSelectList');
    if (!container) return;
    
    let html = '';
    
    cachedProducts
        .filter(p => {
            // Include photo products ONLY if they have stock AND price
            if (p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...') {
                const hasStockAndPrice = p.stock > 0 && p.price > 0;
                console.log(`Photo product "${p.name}": stock=${p.stock}, price=${p.price}, showing=${hasStockAndPrice}`);
                return hasStockAndPrice;
            }
            // Include regular products with stock
            return p.stock > 0;
        })
        .forEach(product => {
            // Add photo thumbnail if available
            const photoHTML = (product.imageUrl && product.imageUrl !== 'uploading...') ? 
                `<img src="${product.imageUrl}" 
                     class="photo-thumbnail-small" 
                     alt="${escapeHtml(product.name)}" 
                     style="width:40px; height:40px; object-fit:cover; border-radius:4px; border:2px solid #e0e0e0; margin-right:8px; vertical-align:middle;"
                     onerror="this.style.display='none'; console.error('Failed to load image for: ${escapeHtml(product.name)}');">` : '';
            
            html += `
                <div class="multi-select-item">
                    <div class="form-check">
                        <input class="form-check-input multi-select-checkbox" type="checkbox" 
                               id="multi-${product.id}" 
                               value="${product.id}"
                               onchange="onMultiSelectChange()">
                        ${photoHTML}
                        <label class="form-check-label" for="multi-${product.id}">
                            ${escapeHtml(product.name)} 
                            <small class="text-muted">(Stock: ${product.stock} ${product.unitType})</small>
                        </label>
                    </div>
                </div>
            `;
        });
    
    container.innerHTML = html || '<small class="text-muted">No products available</small>';
    
    // Debug: Log how many products are shown
    console.log(`Multi-select populated with ${cachedProducts.filter(p => p.stock > 0).length} products`);
}



function toggleMultiSelect() {
    const options = document.getElementById('multiSelectOptions');
    options.classList.toggle('show');
}

function filterMultiSelectOptions() {
    const searchTerm = document.getElementById('multiSelectSearch').value.toLowerCase();
    const items = document.querySelectorAll('.multi-select-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function onMultiSelectChange() {
    const checkedProducts = [];
    
    // Get all checked checkboxes
    document.querySelectorAll('.multi-select-checkbox:checked').forEach(checkbox => {
        const productId = checkbox.value;
        const product = cachedProducts.find(p => p.id === productId);
        if (product) {
            checkedProducts.push(product);
        }
    });
    
    // Update label
    const label = document.getElementById('multiSelectLabel');
    if (checkedProducts.length === 0) {
        label.innerHTML = 'Click to select multiple products...';
    } else {
        label.innerHTML = `<strong>${checkedProducts.length} product${checkedProducts.length > 1 ? 's' : ''} selected</strong>`;
    }
    
    // Auto-populate rows
    ensureEnoughRows(checkedProducts.length);
    populateRowsWithSelectedProducts(checkedProducts);
}

function ensureEnoughRows(needed) {
    const currentRows = document.querySelectorAll('#product-grid-body tr').length;
    if (needed > currentRows) {
        const rowsToAdd = needed - currentRows;
        for (let i = 0; i < rowsToAdd; i++) {
            const currentCount = document.querySelectorAll('#product-grid-body tr').length;
            appendEmptyRow(currentCount + 1);
        }
        updateRowNumbers();
    }
}

function populateRowsWithSelectedProducts(products) {
    products.forEach((product, index) => {
        const rowIndex = index + 1;
        
        // Select product in dropdown
        const select = document.getElementById(`product-${rowIndex}`);
        if (select) {
            select.value = product.id;
            onProductSelect(rowIndex); // Trigger auto-fill
        }
    });
    
    updateGrandTotal();
}

// Close multi-select when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.querySelector('.multi-select-dropdown');
    const options = document.getElementById('multiSelectOptions');
    if (dropdown && !dropdown.contains(e.target) && options) {
        options.classList.remove('show');
    }
});



    
  function initSalesGrid(){
    const body = document.getElementById('product-grid-body');
    body.innerHTML = '';
    for(let i=1;i<=3;i++) appendEmptyRow(i);
    updateRowNumbers();
    updateGrandTotal();
  }

  function appendEmptyRow(index){
    const tbody = document.getElementById('product-grid-body');
    const tr = document.createElement('tr');
    tr.className = 'product-row';
    tr.dataset.custom = 'false';
    tr.innerHTML = `
      <td class="grid-row-number"></td>
      <td>
        <select class="form-select product-select" id="product-${index}" onchange="onProductSelect(${index})">
          <option value="">-- Select Product --</option>
        </select>
      </td>
      <td><input type="text" class="form-control size-input readonly-input" id="size-${index}" readonly /></td>
      <td><input type="number" class="form-control qty-input" id="qty-${index}" min="1" disabled placeholder="Enter quantity" oninput="onQtyChange(${index})"></td>

      <td><input type="text" class="form-control unit-input readonly-input" id="unit-${index}" readonly /></td>
      <td><input type="number" class="form-control price-input readonly-input" id="price-${index}" readonly /></td>
      <td><div id="total-${index}" class="fw-bold">Ã¢â€šÂ¹0.00</div></td>
      <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-x"></i></button></td>
    `;
    tbody.appendChild(tr);
    populateProductSelectForRow(index);
  }

  function addMoreRows(){
    const currentCount = document.querySelectorAll('#product-grid-body .product-row').length;
    for(let i=1;i<=3;i++) appendEmptyRow(currentCount+i);
    updateRowNumbers();
  }

 function removeRow(btn) {
  const tr = btn.closest('tr')
  if(!tr) return
  
  // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ FIX: Don't actually delete the row - just clear/reset it
  const select = tr.querySelector('.product-select')
  const sizeEl = tr.querySelector('.size-input')
  const qtyEl = tr.querySelector('.qty-input')
  const unitEl = tr.querySelector('.unit-input')
  const priceEl = tr.querySelector('.price-input')
  const totalEl = tr.querySelector('[id^="total-"]')
  
  // If custom product, remove from array
  if(select && select.value && select.value.startsWith('CUST_TMP_')) {
    customProductsInSale = customProductsInSale.filter(c => c.tempId !== select.value)
  }
  
  // Reset all fields to empty/default state
  if(select) {
    select.value = ''
    select.disabled = false
  }
  if(sizeEl) sizeEl.value = ''
  if(unitEl) unitEl.value = ''
  if(priceEl) priceEl.value = ''
  if(qtyEl) {
    qtyEl.value = ''
    qtyEl.disabled = true // Disable until product selected
    qtyEl.removeAttribute('max')
  }
  if(totalEl) totalEl.textContent = formatCurrency(0)
  
  // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ CRITICAL: Get row index and re-attach event listener
  const rowIndex = Array.from(tr.parentNode.children).indexOf(tr) + 1;
  
  if(select) {
    // Re-populate select options
    populateProductSelectForRow(rowIndex);
    
    // Re-attach onchange handler
    select.onchange = function() {
      onProductSelect(rowIndex);
    };
  }
  
  updateGrandTotal()
}


  function updateRowNumbers(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    rows.forEach((r,i)=>{
      const idx = i+1;
      r.querySelector('.grid-row-number').textContent = idx;
      // update element ids to keep consistent
      const sel = r.querySelector('.product-select'); if(sel) sel.id = `product-${idx}`;
      const sizeEl = r.querySelector('.size-input'); if(sizeEl) sizeEl.id = `size-${idx}`;
      const qtyEl = r.querySelector('.qty-input'); if(qtyEl){ qtyEl.id = `qty-${idx}`; qtyEl.setAttribute('oninput', `onQtyChange(${idx})`); }
      const unitEl = r.querySelector('.unit-input'); if(unitEl) unitEl.id = `unit-${idx}`;
      const priceEl = r.querySelector('.price-input'); if(priceEl) priceEl.id = `price-${idx}`;
      const totalEl = r.querySelector('[id^=total-]'); if(totalEl) totalEl.id = `total-${idx}`;
      // ensure options refreshed (keeps custom options)
      populateProductSelectForRow(idx);
    });
  }


    // ========== NEW: Sort sales by date (newest first) ==========
function sortSalesByDateDescending() {
    cachedSales.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateB - dateA; // Newest first
    });
    console.log('ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã‚ÂÃƒÂ¢Ã¢â€šÂ¬Ã…Â¾ Sales sorted: newest first');
}

  /***********************
   * Row interactions
   ***********************/
  function onProductSelect(rowIndex){
    const sel = document.getElementById(`product-${rowIndex}`);
    const sizeEl = document.getElementById(`size-${rowIndex}`);
    const unitEl = document.getElementById(`unit-${rowIndex}`);
    const priceEl = document.getElementById(`price-${rowIndex}`);
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    if(!sel) return;
    const val = sel.value;
    if(!val){
      if(sizeEl) sizeEl.value=''; if(unitEl) unitEl.value=''; if(priceEl) priceEl.value=''; if(qtyEl){ qtyEl.value=''; qtyEl.disabled=true; qtyEl.removeAttribute('max'); }
      document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(0);
      updateGrandTotal(); return;
    }
    // if this value is a custom temporary product
    if(val.startsWith('CUST_TMP_')){
      const cp = customProductsInSale.find(c => c.tempId === val);
      if(cp){
        sizeEl.value = cp.size || 'N/A';
        unitEl.value = cp.unitType;
        priceEl.value = cp.price;
        qtyEl.disabled = false;
        qtyEl.max = cp.quantity || '';
        qtyEl.value = cp.quantity || '';
        document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(cp.price * (cp.quantity||0));
        updateGrandTotal();
      }
      return;
    }
    // Normal product from cachedProducts
    const product = (cachedProducts || []).find(p => p.id === val);
    if(!product){ sizeEl.value=''; unitEl.value=''; priceEl.value=''; if(qtyEl){ qtyEl.disabled=true; qtyEl.value=''; } return; }
    sizeEl.value = product.size || 'N/A';
    unitEl.value = product.unitType || '';
    priceEl.value = product.price || 0;
    qtyEl.disabled = false;
    qtyEl.value = '';
    qtyEl.max = product.stock || '';
    document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(0);
    updateGrandTotal();
  }

  function onQtyChange(rowIndex){
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    if(!qtyEl) return;
    const qty = Number(qtyEl.value || 0);
    const max = Number(qtyEl.max || Infinity);
    if(qty > max){
      alert(`ÃƒÂ¢Ã‚ÂÃ…â€™ Quantity exceeds available stock (${max}). Adjusting to max.`);
      qtyEl.value = max;
    }
    updateRowTotal(rowIndex);
    updateGrandTotal();
  }

  function updateRowTotal(rowIndex){
    const price = Number(document.getElementById(`price-${rowIndex}`).value || 0);
    const qty = Number(document.getElementById(`qty-${rowIndex}`).value || 0);
    const total = price * qty;
    const el = document.getElementById(`total-${rowIndex}`);
    if(el) el.textContent = formatCurrency(total);
    return total;
  }

  function updateGrandTotal(){
    let grand = 0;
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    rows.forEach((r,i)=>{
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      if(!sel) return;
      if(!sel.value && r.dataset.custom!=='true') return;
      const qty = Number(document.getElementById(`qty-${idx}`)?.value || 0);
      const price = Number(document.getElementById(`price-${idx}`)?.value || 0);
      const line = qty * price;
      grand += line;
      const totalEl = document.getElementById(`total-${idx}`);
      if(totalEl) totalEl.textContent = formatCurrency(line);
    });
    document.getElementById('grandTotal').textContent = formatCurrency(grand);
    document.getElementById('subtotal').textContent = formatCurrency(grand);
  }

  /***********************
   * CUSTOM PRODUCT: open, validate, add to grid (and optionally inventory)
   ***********************/
function openCustomProductPopup() {
  document.getElementById('customProductForm').reset();
  document.getElementById('customTotal').textContent = 'Ã¢â€šÂ¹0.00';
  new bootstrap.Modal(document.getElementById('customProductModal'), {backdrop: 'static'}).show();
  setTimeout(() => document.getElementById('customName').focus(), 200);
}

  function updateCustomTotalDisplay(){
    const qty = Number(document.getElementById('customQty').value || 0);
    const price = Number(document.getElementById('customPrice').value || 0);
    document.getElementById('customTotal').textContent = formatCurrency(qty * price);
  }
  // Attach in case DOM ready
  document.addEventListener('input', (e)=>{
    if(e.target && (e.target.id==='customQty' || e.target.id==='customPrice')) updateCustomTotalDisplay();
  });

function validateCustomProduct() {
  const name = document.getElementById('customName').value.trim();
  const qty = Number(document.getElementById('customQty').value || 0);
  const price = Number(document.getElementById('customPrice').value || 0);
  
  if (!name || name.length < 2) {
    alert('ÃƒÂ¢Ã‚ÂÃ…â€™ Product name required (min 2 chars)');
    return false;
  }
  
  if (!qty || qty < 1) {
    alert('ÃƒÂ¢Ã‚ÂÃ…â€™ Quantity must be at least 1');
    return false;
  }
  
  if (!price || price <= 0) {
    alert('ÃƒÂ¢Ã‚ÂÃ…â€™ Unit price must be greater than 0');
    return false;
  }
  
  return true;
}


function addCustomProductToGrid() {
  if (!validateCustomProduct()) return;
  
  const name = document.getElementById('customName').value.trim();
  const size = document.getElementById('customSize').value.trim() || 'N/A';
  const qty = Number(document.getElementById('customQty').value || 0);
  const unitType = document.getElementById('customUnit').value || 'Box';
  const price = Number(document.getElementById('customPrice').value || 0);
  
  const tempId = 'CUST_TMP_' + Date.now().toString(36); // Unique temp id
  
  // Store in persistent array
  const cp = {
    tempId: tempId,
    name: name,
    size: size,
    unitType: unitType,
    price: price,
    quantity: qty
  };
  
  customProductsInSale.push(cp);
  
  // Find first empty row or append new row
  let idx = findFirstEmptyRowIndex();
  if (!idx) {
    const count = document.querySelectorAll('#product-grid-body .product-row').length;
    appendEmptyRow(count + 1);
    updateRowNumbers();
    idx = count + 1;
  }
  
  // Populate row with custom data
  populateRowWithCustom(idx, cp);
  updateGrandTotal();
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('customProductModal'));
  if (modal) modal.hide();
  
  // Show success
  alert(`ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Custom product "${name}" added to sale!`);
}


function populateRowWithCustom(rowIndex, cp){
    const sel = document.getElementById(`product-${rowIndex}`);
    if(!sel) return;
    // ensure select contains this option (populateProductSelectForRow will add it)
    populateProductSelectForRow(rowIndex);
    // create or update option
    let opt = Array.from(sel.options).find(o=>o.value===cp.tempId);
    if(!opt){
      opt = document.createElement('option');
      opt.value = cp.tempId;
      opt.text = `${cp.name} (Custom)`;
      opt.dataset.size = cp.size;
      opt.dataset.unit = cp.unitType;
      opt.dataset.price = cp.price;
      opt.dataset.stock = cp.quantity;
      sel.appendChild(opt);
    }
    sel.value = cp.tempId;
    document.getElementById(`size-${rowIndex}`).value = cp.size;
    document.getElementById(`unit-${rowIndex}`).value = cp.unitType;
    document.getElementById(`price-${rowIndex}`).value = cp.price;
    
    // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ FIX: Make quantity editable for custom products
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    qtyEl.disabled = false;  // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Keep enabled
    qtyEl.readOnly = false;  // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Not read-only
    qtyEl.value = cp.quantity;
    qtyEl.max = cp.quantity; // Can increase up to this amount
    
    // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Add event listener to update total when quantity changes
    qtyEl.addEventListener('input', function() {
        const newQty = parseFloat(this.value) || 0;
        const price = parseFloat(document.getElementById(`price-${rowIndex}`).value) || 0;
        const total = newQty * price;
        document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(total);
        updateGrandTotal();
    });
    
    // Set initial total
    document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(cp.price * cp.quantity);
}



  function findFirstEmptyRowIndex(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    for(let i=0;i<rows.length;i++){
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      if(!sel || !sel.value) return idx;
    }
    return null;
  }

  /***********************
   * COMPLETE SALE (fire-and-forget background saves)
   ***********************/
 /**
 * ==========================================
 * Ã¢Å“â€¦ FIXED: Sequential sale saving with delay
 * ==========================================
 */

// ==========================================
// COMPLETE SALE - OPTIMISTIC UI + BACKGROUND SAVE
// ==========================================

// ==========================================
// COMPLETE SALE - OPTIMISTIC UI + BACKGROUND SAVE
// ==========================================
async function completeSale() {
  // Collect valid sale items from the form
  const saleItems = [];
  const rows = document.querySelectorAll('#product-grid-body .product-row');
  const saleId = 'SALE_' + Date.now().toString(36);
  
  rows.forEach((r, i) => {
    const idx = i + 1;
    const sel = document.getElementById(`product-${idx}`);
    const qtyEl = document.getElementById(`qty-${idx}`);
    
    if (!sel || !sel.value || !qtyEl || !qtyEl.value || Number(qtyEl.value) <= 0) {
      return; // Skip empty rows
    }
    
    const productId = sel.value;
    const quantity = Number(qtyEl.value);
    const unitPrice = Number(document.getElementById(`price-${idx}`).value || 0);
    const totalAmount = quantity * unitPrice;
    const size = document.getElementById(`size-${idx}`).value || 'N/A';
    const unitType = document.getElementById(`unit-${idx}`).value || '';
    
    // Check if custom product
    const isCustom = productId.startsWith('CUST_TMP_');
    let productName = '';
    
    if (isCustom) {
      const cp = customProductsInSale.find(c => c.tempId === productId);
      productName = cp ? cp.name : 'Custom Product';
    } else {
      const prod = cachedProducts.find(p => p.id === productId);
      productName = prod ? prod.name : 'Unknown Product';
    }
    
    saleItems.push({
      saleId: saleId,
      productId: isCustom ? '' : productId,
      productName: productName,
      size: size,
      quantity: quantity,
      unitType: unitType,
      unitPrice: unitPrice,
      totalAmount: totalAmount,
      isCustomProduct: isCustom
    });
  });
  
  // Validation
  if (saleItems.length === 0) {
    alert('Ã¢Å¡ Ã¯Â¸Â No products selected. Please add at least one product to complete the sale.');
    return;
  }
  
  const totalAmount = saleItems.reduce((sum, item) => sum + item.totalAmount, 0);
  
  if (!confirm(`Ã°Å¸â€œÂ¦ Complete sale with ${saleItems.length} item(s)?\n\nTotal: ${formatCurrency(totalAmount)}`)) {
    return;
  }
  
  console.log(`Ã¢Å“â€¦ Sale confirmed: ${saleItems.length} items, total ${formatCurrency(totalAmount)}`);
  
  // ==========================================
  // Ã¢Å“â€¦ STEP 1: INSTANT UI UPDATES (< 100ms)
  // ==========================================
  
  // Add to local cache immediately
  saleItems.forEach(item => {
    const newSale = {
      id: generateId(),
      saleId: item.saleId,
      productId: item.productId,
      productName: item.productName,
      size: item.size,
      quantity: item.quantity,
      unitType: item.unitType,
      unitPrice: item.unitPrice,
      totalAmount: item.totalAmount,
      date: new Date().toISOString(),
      isCustomProduct: item.isCustomProduct
    };
    cachedSales.unshift(newSale);
    
    // Update stock locally (for non-custom products)
    if (!item.isCustomProduct && item.productId) {
      const prod = cachedProducts.find(p => p.id === item.productId);
      if (prod) {
        prod.stock -= item.quantity;
      }
    }
  });
  
  // Re-render UI immediately
  renderProducts();
  renderSales();
  updateSummaryFromCache();
  
  // Close modal immediately
  const modal = bootstrap.Modal.getInstance(document.getElementById('salesModal'));
  if (modal) modal.hide();
  
  // Reset custom products array
  customProductsInSale = [];
  
  // Show success toast notification
  showSuccessToast(`Ã¢Å“â€¦ Sale completed! ${saleItems.length} item(s) recorded.`);
  
  console.log(`Ã¢Å“â€¦ UI updated instantly - ${saleItems.length} items displayed`);
  
  // ==========================================
  // Ã°Å¸â€â€ž STEP 2: BACKGROUND SAVE TO GOOGLE SHEETS
  // ==========================================
  
  // Add items to background save queue
  saleItems.forEach(item => {
    backgroundSaveQueue.push(item);
  });
  
  console.log(`Ã°Å¸â€â€ž Added ${saleItems.length} items to background save queue (queue size: ${backgroundSaveQueue.length})`);
  
  // Start background processor (if not already running)
  if (!isProcessingQueue) {
    setTimeout(() => {
      processBackgroundSaveQueue();
    }, 100); // Small delay to let UI settle
  } else {
    console.log('Ã¢ÂÂ³ Background processor already running, items will be processed in sequence');
  }
}


    // ==========================================
// SUCCESS TOAST NOTIFICATION
// ==========================================

function showSuccessToast(message) {
  // Remove existing toast if any
  const existingToast = document.getElementById('successToast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Create toast element
  const toast = document.createElement('div');
  toast.id = 'successToast';
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 1.5rem;"></i>
      <div>${message}</div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Show toast
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  // Hide after 3 seconds
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      toast.remove();
    }, 300);
  }, 3000);
}

  
  


  /***********************
   * Load sale product select helper (if needed elsewhere)
   ***********************/
  function loadProductsForSaleFromCache(){
    // not used directly now (we populate selects per-row), but keep for compatibility
  }

  /***********************
   * Backup/Import
   ***********************/
  function exportData(){
    const data = { products: cachedProducts, sales: cachedSales, exportDate: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
    alert('ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ Backup downloaded');
  }
  function importData(){ document.getElementById('fileInput').click(); }
  function handleFileImport(e){ const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(evt){ try{ const data = JSON.parse(evt.target.result); if(data.products) cachedProducts = data.products; if(data.sales) cachedSales = data.sales; hasInitialLoaded=true; renderProducts(); renderSales(); alert('ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ Data restored (local)'); }catch(err){ alert('ÃƒÂ¢Ã‚ÂÃ…â€™ Invalid file'); } }; reader.readAsText(file); }

      function searchProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    // If empty, display all products
    if (!searchTerm) {
        displayAllProducts();
        return;
    }
    
    // Filter products
    const filteredProducts = cachedProducts.filter(product => {
        const name = (product.name || '').toLowerCase();
        const category = (product.category || '').toLowerCase();
        const brand = (product.brand || '').toLowerCase();
        const size = (product.size || '').toLowerCase();
        
        return name.includes(searchTerm) ||
               category.includes(searchTerm) ||
               brand.includes(searchTerm) ||
               size.includes(searchTerm);
    });
    
    // Display filtered products
    displayProducts(filteredProducts);
}

function displayProducts(products) {
    const tbody = document.getElementById('productsTableBody');
    
    if (products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                    <i class="bi bi-search"></i>
                    <p>No products found matching your search</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    products.forEach(product => {
        const iconColor = categoryIconColor(product.category);
        const stockClass = product.stock > product.minStock ? 'In Stock' : 
                          product.stock > 0 ? 'Low' : 'Out of Stock';
        const stockBadgeClass = product.stock > product.minStock ? 'bg-success' : 
                               product.stock > 0 ? 'bg-warning' : 'bg-danger';
        
        html += `
            <tr>
                <td><i class="bi bi-file-earmark-fill" style="color:${iconColor}"></i></td>
                <td>${escapeHtml(product.name)}</td>
                <td>${escapeHtml(product.category)}</td>
                <td>${escapeHtml(product.brand) || '-'}</td>
                <td><strong>${escapeHtml(product.size) || 'N/A'}</strong></td>
                <td><span class="badge ${stockBadgeClass}">${stockClass} (${product.stock})</span></td>
                <td>Ã¢â€šÂ¹${product.price.toFixed(2)}/${product.unitType}</td>
                <td>
                    <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${product.id}')">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${product.id}')">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // Also update mobile list
    const container = document.getElementById('mobileProductsList');
    if (products.length === 0) {
        container.innerHTML = '<div class="mobile-item text-center text-muted">No products found</div>';
        return;
    }
    
    let mobileHtml = '';
    products.forEach(p => {
        const iconColor = categoryIconColor(p.category);
        const stockBadge = stockBadgeHtml(p.stock, p.minStock);
        mobileHtml += `
            <div class="mobile-item d-flex align-items-start justify-content-between">
                <div style="display:flex;gap:.8rem;align-items:center">
                    <div style="width:36px;text-align:center">
                        <i class="bi bi-file-earmark-fill" style="font-size:1.25rem;color:${iconColor}"></i>
                    </div>
                    <div>
                        <div style="font-weight:600">${escapeHtml(p.name)}</div>
                        <div class="small-muted">${escapeHtml(p.category)} ${escapeHtml(p.brand)}</div>
                        <div class="small-muted"><strong>${escapeHtml(p.size)}</strong> Ã¢â€šÂ¹${parseFloat(p.price || 0).toFixed(2)}/${p.unitType}</div>
                    </div>
                </div>
                <div style="text-align:right">
                    ${stockBadge}
                    <div style="margin-top:.5rem">
                        <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    container.innerHTML = mobileHtml;
}

function displayAllProducts() {
    displayProducts(cachedProducts);
}


    // Open Clear Sales popup
function openClearSalesPopup() {
    // Set default dates (last 30 days to today)
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('clearFromDate').value = formatDateForInput(thirtyDaysAgo);
    document.getElementById('clearToDate').value = formatDateForInput(today);
    
    // Reset count display
    document.getElementById('clearSalesCount').style.display = 'none';
    
    // Add event listeners to count on date change
    document.getElementById('clearFromDate').addEventListener('change', updateClearSalesCount);
    document.getElementById('clearToDate').addEventListener('change', updateClearSalesCount);
    
    // Open modal
    const modal = new bootstrap.Modal(document.getElementById('clearSalesModal'));
    modal.show();
    
    // Initial count
    updateClearSalesCount();
}

// Format date for input field (YYYY-MM-DD)
function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Update count of sales in selected date range
function updateClearSalesCount() {
    const fromDate = new Date(document.getElementById('clearFromDate').value);
    const toDate = new Date(document.getElementById('clearToDate').value);
    
    if (!fromDate || !toDate) return;
    
    if (fromDate > toDate) {
        alert('ÃƒÂ¢Ã‚ÂÃ…â€™ "From Date" cannot be after "To Date"');
        return;
    }
    
    // Count sales in range
    const salesInRange = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= fromDate && saleDate <= toDate;
    });
    
    // Display count
    const countDiv = document.getElementById('clearSalesCount');
    const countNumber = document.getElementById('salesCountNumber');
    
    countNumber.textContent = salesInRange.length;
    countDiv.style.display = salesInRange.length > 0 ? 'block' : 'none';
}

// Clear sales in date range
function clearSalesInDateRange() {
    const fromDate = new Date(document.getElementById('clearFromDate').value);
    const toDate = new Date(document.getElementById('clearToDate').value);
    
    if (!fromDate || !toDate) {
        alert('ÃƒÂ¢Ã‚ÂÃ…â€™ Please select both From and To dates');
        return;
    }
    
    // Set time to start/end of day for accurate comparison
    fromDate.setHours(0, 0, 0, 0);
    toDate.setHours(23, 59, 59, 999);
    
    if (fromDate > toDate) {
        alert('ÃƒÂ¢Ã‚ÂÃ…â€™ "From Date" cannot be after "To Date"');
        return;
    }
    
    // Find sales in date range
    const salesInRange = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= fromDate && saleDate <= toDate;
    });
    
    if (salesInRange.length === 0) {
        alert('ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¾Ãƒâ€šÃ‚Â¹ÃƒÆ’Ã‚Â¯Ãƒâ€šÃ‚Â¸Ãƒâ€šÃ‚Â No sales found in the selected date range');
        return;
    }
    
    // Confirm deletion
    const fromStr = fromDate.toLocaleDateString('en-IN');
    const toStr = toDate.toLocaleDateString('en-IN');
    const confirmMsg = `Are you sure you want to hide ${salesInRange.length} sales records between ${fromStr} and ${toStr}?\n\nÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã‚Â¡ ÃƒÆ’Ã‚Â¯Ãƒâ€šÃ‚Â¸Ãƒâ€šÃ‚Â This will hide them from display only.\nGoogle Sheets data remains unchanged.\n\nYou can restore them later by clearing browser data.`;
    
    if (!confirm(confirmMsg)) return;
    
    // ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ FIX: Store deleted IDs persistently
    salesInRange.forEach(sale => {
        if (sale.id && !deletedSaleIds.includes(sale.id)) {
            deletedSaleIds.push(sale.id);
        }
    });
    
    // Save to localStorage for persistence across sessions and page reloads
    try {
        localStorage.setItem('deletedSaleIds', JSON.stringify(deletedSaleIds));
        console.log('ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢Ãƒâ€šÃ‚Â¾ Saved', deletedSaleIds.length, 'deleted sale IDs to localStorage');
    } catch (e) {
        console.warn('Could not save deletedSaleIds to localStorage', e);
    }
    
    // Filter out sales in the date range
    cachedSales = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate < fromDate || saleDate > toDate;
    });
    
    // Update display
    displaySalesFromCache();
    updateSummaryFromCache();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('clearSalesModal'));
    modal.hide();
    
    // Show success message
    alert(`ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ Successfully cleared ${salesInRange.length} sales records!\n\nNote: They're hidden from display only. Google Sheets data is unchanged.\n\nTo restore: Clear browser data or use developer console to run:\nlocalStorage.removeItem('deletedSaleIds')`);
}


   function displaySalesFromCache() {
  const salesList = document.getElementById('salesList');
  
  if (cachedSales.length === 0) {
    salesList.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted py-4">
          No sales recorded yet
        </td>
      </tr>
    `;
    return;
  }
  
  salesList.innerHTML = '';
  
  // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ FIX: Show only last 100 sales (most recent)
  const recentSales = cachedSales.slice(0, 100);
  
  recentSales.forEach(sale => {
    const date = new Date(sale.date);
    const formattedDate = date.toLocaleDateString('en-IN') + ' ' + 
                         date.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'});
    
    const row = `
      <tr>
        <td>${formattedDate}</td>
        <td>${sale.productName}</td>
        <td>${sale.quantity}</td>
        <td>${sale.unitType}</td>
        <td class="text-success fw-bold">Ã¢â€šÂ¹${parseFloat(sale.totalAmount).toFixed(2)}</td>
      </tr>
    `;
    
    salesList.innerHTML += row;
  });
  
  // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ FIX: Show count if more than 100 sales exist
  if (cachedSales.length > 100) {
    salesList.innerHTML += `
      <tr>
        <td colspan="5" class="text-center text-muted">
          <small>Showing 100 most recent sales. Total: ${cachedSales.length} sales</small>
        </td>
      </tr>
    `;
  }
}

/**
 * ==========================================
 * âœ… PHOTO PRODUCT FUNCTIONALITY
 * ==========================================
 */

// Photo selection variables
let selectedPhotoFile = null;
let selectedPhotoBase64 = null;

// Open photo product modal
function openPhotoProductModal() {
  // Reset form
  document.getElementById('photoProductName').value = '';
  document.getElementById('photoProductBrand').value = '';
  document.getElementById('photoProductSize').value = '';
  document.getElementById('photoProductStock').value = '';
  document.getElementById('photoProductPrice').value = '';
  document.getElementById('photoPreviewContainer').style.display = 'none';
  document.getElementById('photoLoadingSpinner').style.display = 'none';
  selectedPhotoFile = null;
  selectedPhotoBase64 = null;
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('photoProductModal'));
  modal.show();
}

// Handle photo selection
function handlePhotoSelect(event) {
  const file = event.target.files[0];
  if (!file || !file.type.startsWith('image/')) {
    alert('Please select a valid image file');
    return;
  }
  
  selectedPhotoFile = file;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      const maxWidth = 1920;
      const maxHeight = 1080;
      let width = img.width;
      let height = img.height;
      
      if (width > height) {
        if (width > maxWidth) {
          height = (maxWidth / width) * height;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width = (maxHeight / height) * width;
          height = maxHeight;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);
      
      selectedPhotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
      
      document.getElementById('photoPreviewImage').src = selectedPhotoBase64;
      document.getElementById('photoPreviewContainer').style.display = 'block';
      
      console.log('Photo selected and compressed:', file.name);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// Clear photo selection
function clearPhotoSelection() {
  selectedPhotoFile = null;
  selectedPhotoBase64 = null;
  document.getElementById('photoFileInput').value = '';
  document.getElementById('photoCameraInput').value = '';
  document.getElementById('photoPreviewContainer').style.display = 'none';
}

// Save photo product
async function savePhotoProduct() {
  const productName = document.getElementById('photoProductName').value.trim();
  if (!productName) {
    alert('Product name is required!');
    return;
  }
  
  if (!selectedPhotoBase64) {
    alert('Please take or select a photo!');
    return;
  }
  
  const productData = {
    id: generateId(),
    name: productName,
    category: 'Photo Products',
    brand: document.getElementById('photoProductBrand').value.trim() || '',
    size: document.getElementById('photoProductSize').value.trim() || '',
    unitType: 'Piece',
    piecesPerBox: '',
    sftPerBox: '',
    price: parseFloat(document.getElementById('photoProductPrice').value) || 0,
    stock: parseFloat(document.getElementById('photoProductStock').value) || 0,
    minStock: 0,
    imageUrl: 'uploading...'
  };
  
  cachedProducts.push(productData);
  renderProducts();
  
  const modalEl = document.getElementById('photoProductModal');
  const modal = bootstrap.Modal.getInstance(modalEl);
  modal.hide();
  
  showSuccessToast('Photo product added! Uploading image...');
  
  uploadPhotoToBackend(productData, selectedPhotoBase64);
}

// Upload photo to backend
async function uploadPhotoToBackend(productData, photoBase64) {
  try {
    console.log('Uploading photo to Google Drive...');
    
    document.getElementById('photoLoadingSpinner').style.display = 'block';
    
    const formData = new URLSearchParams({
      action: 'uploadPhoto',
      email: userEmail,
      hash: userHash,
      imageData: photoBase64,
      fileName: `product_${productData.id}_${Date.now()}.jpg`
    });
    
    const photoResponse = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      body: formData,
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    });
    
    const photoResult = await photoResponse.json();
    
    if (photoResult.success && photoResult.photoUrl) {
      console.log('Photo uploaded successfully:', photoResult.photoUrl);
      
      productData.imageUrl = photoResult.photoUrl;
      
      const productIndex = cachedProducts.findIndex(p => p.id === productData.id);
      if (productIndex !== -1) {
        cachedProducts[productIndex].imageUrl = photoResult.photoUrl;
      }
      
      await saveProductToSheet(productData);
      
      renderProducts();
      showSuccessToast('âœ… Photo uploaded successfully!');
      
    } else {
      throw new Error(photoResult.error || 'Photo upload failed');
    }
    
  } catch (error) {
    console.error('Photo upload error:', error);
    alert('Failed to upload photo. Product saved without image.');
    
    productData.imageUrl = '';
    
    const productIndex = cachedProducts.findIndex(p => p.id === productData.id);
    if (productIndex !== -1) {
      cachedProducts[productIndex].imageUrl = '';
    }
    
    await saveProductToSheet(productData);
    renderProducts();
    
  } finally {
    document.getElementById('photoLoadingSpinner').style.display = 'none';
  }
}

// Show all products (table view)
function showAllProducts() {
  document.getElementById('btnAllView').classList.add('active');
  document.getElementById('btnPhotoView').classList.remove('active');
  
  document.querySelector('.table-explorer').style.display = 'block';
  document.getElementById('photoProductGrid').style.display = 'none';
  
  renderProducts();
}
// Show photo products (grid view)
function showPhotoProducts() {
  document.getElementById('btnAllView').classList.remove('active');
  document.getElementById('btnPhotoView').classList.add('active');
  
  document.querySelector('.table-explorer').style.display = 'none';
  const photoGrid = document.getElementById('photoProductGrid');
  photoGrid.style.display = 'flex';
  photoGrid.innerHTML = '';
  
  // Filter photo products
  const photoProducts = cachedProducts.filter(p => {
    const hasImage = p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...';
    console.log(`Product "${p.name}": imageUrl="${p.imageUrl}", showing=${hasImage}`);
    return hasImage;
  });
  
  console.log(`Found ${photoProducts.length} photo products`);
  
  if (photoProducts.length === 0) {
    photoGrid.innerHTML = `
      <div class="col-12">
        <div class="alert alert-info text-center">
          <i class="bi bi-images" style="font-size: 3rem;"></i><br>
          <strong>No photo products yet.</strong><br>
          Click <strong>"Product by Photo"</strong> to add one!
        </div>
      </div>
    `;
    return;
  }
  
  photoProducts.forEach(product => {
    const stockBadge = product.stock > 0 ? 
      `<span class="badge bg-success">Stock: ${product.stock}</span>` : 
      `<span class="badge bg-danger">Out of Stock</span>`;
    
    const priceDisplay = product.price > 0 ? `â‚¹${product.price.toFixed(2)}` : 'Price not set';
    
    const card = `
      <div class="col">
        <div class="card h-100 shadow-sm">
          <img src="${product.imageUrl}" 
               class="card-img-top" 
               alt="${escapeHtml(product.name)}" 
               style="height:200px; object-fit:cover; cursor:pointer;" 
               onclick="viewPhotoProduct('${product.id}')"
               onerror="this.onerror=null; this.src='https://via.placeholder.com/200?text=Image+Not+Found'; console.error('Failed to load image for card: ${escapeHtml(product.name)}');">
          <div class="card-body">
            <h6 class="card-title">${escapeHtml(product.name)}</h6>
            <p class="card-text small mb-2">
              ${product.brand ? `<strong>Brand:</strong> ${escapeHtml(product.brand)}<br>` : ''}
              ${product.size ? `<strong>Size:</strong> ${escapeHtml(product.size)}<br>` : ''}
              ${stockBadge}<br>
              <strong>Price:</strong> ${priceDisplay}
            </p>
          </div>
          <div class="card-footer bg-white border-0 d-flex gap-2">
            <!-- âœ… FIXED: Call editProduct which opens the correct modal -->
            <button class="btn btn-sm btn-primary flex-fill" onclick="editProduct('${product.id}')">
              <i class="bi bi-pencil"></i> Edit
            </button>
            <!-- âœ… FIXED: Call deleteProduct with proper confirmation -->
            <button class="btn btn-sm btn-danger flex-fill" onclick="deleteProduct('${product.id}')">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>
    `;
    photoGrid.innerHTML += card;
  });
}



// View photo product enlarged
function viewPhotoProduct(productId) {
  const product = cachedProducts.find(p => p.id === productId);
  if (!product) {
    alert('Product not found');
    return;
  }
  
  document.getElementById('viewPhotoModalTitle').textContent = product.name;
  document.getElementById('viewPhotoModalBody').innerHTML = `
    <div class="text-center">
      <img src="${product.imageUrl}" 
           class="img-fluid mb-3" 
           alt="${product.name}"
           style="max-height: 500px; border-radius: 10px;"
           onerror="this.src='https://via.placeholder.com/500?text=Image+Not+Found'">
      <table class="table table-bordered mt-3">
        <tr><th>Product Name</th><td>${product.name}</td></tr>
        <tr><th>Category</th><td>${product.category || 'N/A'}</td></tr>
        <tr><th>Brand</th><td>${product.brand || 'N/A'}</td></tr>
        <tr><th>Size</th><td>${product.size || 'N/A'}</td></tr>
        <tr><th>Stock</th><td>${product.stock || 0} ${product.unitType || 'Pieces'}</td></tr>
        <tr><th>Price</th><td>â‚¹${formatCurrency(product.price || 0)}</td></tr>
        <tr><th>Minimum Stock Alert</th><td>${product.minStock || 0}</td></tr>
      </table>
    </div>
  `;
  
  const modal = new bootstrap.Modal(document.getElementById('viewPhotoModal'));
  modal.show();
}


  /***********************
   * Init
   ***********************/
  document.addEventListener('DOMContentLoaded', ()=>{
    // initial placeholders
    renderProducts();
    renderSales();
    syncFromGoogleSheets();
  });


    /***********************
 * INVOICE GENERATOR
 ***********************/

// Global variable to store invoice number counter
let invoiceCounter = parseInt(localStorage.getItem('lastInvoiceNumber') || '0');

function generateInvoice() {
  // Collect products from sale grid
  const rows = document.querySelectorAll('#product-grid-body .product-row');
  const items = [];
  
  rows.forEach((r, i) => {
    const idx = i + 1;
    const sel = document.getElementById(`product-${idx}`);
    const qtyEl = document.getElementById(`qty-${idx}`);
    const priceEl = document.getElementById(`price-${idx}`);
    const sizeEl = document.getElementById(`size-${idx}`);
    
    // Skip if no product selected or no quantity
    if (!sel || !sel.value || !qtyEl || !qtyEl.value || Number(qtyEl.value) <= 0) {
      return; // Continue to next iteration
    }
    
    // Get clean product name without stock info
    let productName = sel.options[sel.selectedIndex]?.text || 'Product';
    // Remove stock information (e.g., "Stock: 147 Box")
    productName = productName.replace(/\(Stock:.*?\)/g, '').trim();
    
    const quantity = Number(qtyEl.value);
    const rate = Number(priceEl.value) || 0;
    const size = sizeEl.value;
    
    items.push({
      name: productName,
      size: size,
      quantity: quantity,
      rate: rate,
      amount: quantity * rate
    });
  });
  
  if (items.length === 0) {
    alert('âš ï¸ No products in the sale! Add products before generating invoice.');
    return;
  }
  
  // Store items temporarily
  window.tempInvoiceItems = items;
  
  // âœ… FIX: Close Sales Modal BEFORE opening Invoice Modal
  const salesModal = bootstrap.Modal.getInstance(document.getElementById('salesModal'));
  if (salesModal) {
    salesModal.hide();
  }
  
  // Wait for sales modal to close, then open invoice modal
  setTimeout(() => {
    openInvoiceModal();
  }, 300); // 300ms delay ensures smooth transition
}



function openInvoiceModal() {

  
  // Check if modal exists
  const modalEl = document.getElementById('invoiceModal');
  
  
  if (!modalEl) {
    
    return;
  }
  
  
  // Generate invoice number
  invoiceCounter++;
  const invoiceNo = 'INV-' + String(invoiceCounter).padStart(6, '0');
  
  const invoiceNumEl = document.getElementById('invoiceNumber');
  
  if (invoiceNumEl) {
    invoiceNumEl.value = invoiceNo;
  }
  
  localStorage.setItem('lastInvoiceNumber', invoiceCounter);
  
 
  // Set today's date
  const today = new Date().toISOString().split('T')[0];
  const dateEl = document.getElementById('invoiceDate');
  if (dateEl) {
    dateEl.value = today;
  }
  

  calculateDueDate();
  populateInvoiceItems();
  loadDefaultTerms();
  
  // Show modal
  try {
    const bsModal = new bootstrap.Modal(modalEl);
    bsModal.show();
 
  } catch (error) {
    
  }
}


// Regenerate Invoice Number
function regenerateInvoiceNumber() {
  invoiceCounter++;
  const invoiceNo = 'INV-' + String(invoiceCounter).padStart(6, '0');
  document.getElementById('invoiceNumber').value = invoiceNo;
  localStorage.setItem('lastInvoiceNumber', invoiceCounter);
}

// Calculate Due Date based on Payment Terms
function calculateDueDate() {
  const invoiceDate = new Date(document.getElementById('invoiceDate').value);
  const terms = parseInt(document.getElementById('paymentTerms').value);
  
  const dueDate = new Date(invoiceDate);
  dueDate.setDate(dueDate.getDate() + terms);
  
  document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
}

// Populate Invoice Items from Sale
function populateInvoiceItems() {
  const tbody = document.getElementById('invoiceItemsBody');
  tbody.innerHTML = '';
  
  if (!window.tempInvoiceItems || window.tempInvoiceItems.length === 0) return;
  
  window.tempInvoiceItems.forEach((item, index) => {
    const row = createInvoiceRow(item, index);
    tbody.innerHTML += row;
  });
  
  calculateInvoiceTotal();
}

// Create Invoice Row HTML
function createInvoiceRow(item, index) {
  const itemName = item.size ? `${item.name} (${item.size})` : item.name;
  return `
    <tr data-index="${index}">
      <td>
        <input type="text" class="form-control form-control-sm" 
               value="${escapeHtml(itemName)}" 
               oninput="calculateInvoiceTotal()">
      </td>
      <td>
        <input type="number" class="form-control form-control-sm text-center invoice-qty" 
               value="${item.quantity}" min="1" 
               oninput="updateInvoiceRowTotal(${index})">
      </td>
      <td>
        <input type="number" class="form-control form-control-sm text-end invoice-rate" 
               value="${item.rate}" min="0" step="0.01" 
               oninput="updateInvoiceRowTotal(${index})">
      </td>
      <td class="text-end fw-bold invoice-row-total">
        Ã¢â€šÂ¹${(item.quantity * item.rate).toFixed(2)}
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-sm btn-link text-danger" 
                onclick="deleteInvoiceRow(${index})">
          <i class="bi bi-x-lg"></i>
        </button>
      </td>
    </tr>
  `;
}

// Update Invoice Row Total
function updateInvoiceRowTotal(index) {
  const row = document.querySelector(`#invoiceItemsBody tr[data-index="${index}"]`);
  if (!row) return;
  
  const qty = parseFloat(row.querySelector('.invoice-qty').value) || 0;
  const rate = parseFloat(row.querySelector('.invoice-rate').value) || 0;
  const total = qty * rate;
  
  row.querySelector('.invoice-row-total').textContent = formatCurrency(total);
  calculateInvoiceTotal();
}

// Delete Invoice Row
function deleteInvoiceRow(index) {
  const row = document.querySelector(`#invoiceItemsBody tr[data-index="${index}"]`);
  if (row) {
    row.remove();
    calculateInvoiceTotal();
  }
}

// Add New Invoice Row
function addInvoiceRow() {
  const tbody = document.getElementById('invoiceItemsBody');
  const index = tbody.querySelectorAll('tr').length;
  
  const newItem = {
    name: '',
    size: '',
    quantity: 1,
    rate: 0,
    amount: 0
  };
  
  tbody.innerHTML += createInvoiceRow(newItem, index);
}

// Calculate Invoice Total
function calculateInvoiceTotal() {
  // Calculate subtotal
  let subtotal = 0;
  document.querySelectorAll('#invoiceItemsBody tr').forEach(row => {
    const qty = parseFloat(row.querySelector('.invoice-qty')?.value) || 0;
    const rate = parseFloat(row.querySelector('.invoice-rate')?.value) || 0;
    subtotal += qty * rate;
  });
  
  document.getElementById('invoiceSubtotal').textContent = formatCurrency(subtotal);
  
  // Calculate discount
  const discountValue = parseFloat(document.getElementById('invoiceDiscount').value) || 0;
  const discountType = document.getElementById('invoiceDiscountType').value;
  let discount = 0;
  
  if (discountType === 'amount') {
    discount = discountValue;
  } else {
    discount = (subtotal * discountValue) / 100;
  }
  
  document.getElementById('invoiceDiscountAmount').textContent = '-' + formatCurrency(discount);
  
  // Calculate tax
  const taxRate = parseFloat(document.getElementById('invoiceTaxRate').value) || 0;
  const taxableAmount = subtotal - discount;
  const tax = (taxableAmount * taxRate) / 100;
  
  document.getElementById('invoiceTaxAmount').textContent = formatCurrency(tax);
  
  // Calculate grand total
  const grandTotal = taxableAmount + tax;
  document.getElementById('invoiceGrandTotal').textContent = formatCurrency(grandTotal);
}

// Load Default Terms & Conditions
function loadDefaultTerms() {
  const defaultTerms = `1. Payment due within 14 days of invoice date
2. Late payments subject to 2% monthly interest charge
3. Goods once sold cannot be returned or exchanged
4. Delivery charges may apply for orders under Ã¢â€šÂ¹10,000
5. Company not responsible for damages during transit`;
  
  document.getElementById('invoiceTerms').value = defaultTerms;
}

// Save Invoice
async function saveInvoice() {
  // Validate required fields
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  
  if (!customerName) {
    alert('ÃƒÂ¢Ã‚ÂÃ…â€™ Please enter customer name');
    return;
  }
  
  // Collect invoice data
  const invoiceData = collectInvoiceData();
  
  // Save to localStorage
  let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  invoices.push(invoiceData);
  localStorage.setItem('invoices', JSON.stringify(invoices));
  
  alert('ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Invoice saved successfully!\n\nInvoice Number: ' + invoiceData.invoiceNumber);
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('invoiceModal'));
  if (modal) modal.hide();
}

// Collect Invoice Data
function collectInvoiceData() {
  const items = [];
  document.querySelectorAll('#invoiceItemsBody tr').forEach(row => {
    const name = row.querySelector('input[type="text"]').value;
    const qty = parseFloat(row.querySelector('.invoice-qty').value) || 0;
    const rate = parseFloat(row.querySelector('.invoice-rate').value) || 0;
    
    if (name && qty > 0) {
      items.push({
        name: name,
        quantity: qty,
        rate: rate,
        amount: qty * rate
      });
    }
  });
  
  const subtotal = parseFloat(document.getElementById('invoiceSubtotal').textContent.replace(/[Ã¢â€šÂ¹,]/g, ''));
  const discount = parseFloat(document.getElementById('invoiceDiscountAmount').textContent.replace(/[Ã¢â€šÂ¹,-]/g, ''));
  const tax = parseFloat(document.getElementById('invoiceTaxAmount').textContent.replace(/[Ã¢â€šÂ¹,]/g, ''));
  const total = parseFloat(document.getElementById('invoiceGrandTotal').textContent.replace(/[Ã¢â€šÂ¹,]/g, ''));
  
  return {
    invoiceNumber: document.getElementById('invoiceNumber').value,
    customerName: document.getElementById('invoiceCustomerName').value,
    invoiceDate: document.getElementById('invoiceDate').value,
    dueDate: document.getElementById('invoiceDueDate').value,
    items: items,
    subtotal: subtotal,
    discount: discount,
    tax: tax,
    total: total,
    notes: document.getElementById('invoiceNotes').value,
    terms: document.getElementById('invoiceTerms').value,
    createdAt: new Date().toISOString()
  };
}

// Preview Invoice
function previewInvoice() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('ÃƒÂ¢Ã‚ÂÃ…â€™ Please enter customer name');
    return;
  }
  
  // Generate HTML for invoice
  const invoiceHTML = generateInvoiceHTML(invoiceData);
  
  // Open in new window
  const previewWindow = window.open('', 'Invoice Preview', 'width=800,height=600');
  previewWindow.document.write(invoiceHTML);
  previewWindow.document.close();
}

// Generate Invoice HTML for Preview/Print
function generateInvoiceHTML(data) {
  let itemsHTML = '';
  data.items.forEach((item, index) => {
    itemsHTML += `
      <tr>
        <td style="text-align: center">${index + 1}</td>
        <td>${escapeHtml(item.name)}</td>
        <td style="text-align: center">${item.quantity}</td>
        <td style="text-align: right">Ã¢â€šÂ¹${item.rate.toFixed(2)}</td>
        <td style="text-align: right">Ã¢â€šÂ¹${item.amount.toFixed(2)}</td>
      </tr>
    `;
  });
  
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Invoice ${data.invoiceNumber}</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 40px; }
        .invoice-header { text-align: center; margin-bottom: 30px; }
        .invoice-details { margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; }
        th { background-color: #f8f9fa; }
        .text-right { text-align: right; }
        .total-row { font-weight: bold; background-color: #e9ecef; }
        @media print {
          button { display: none; }
        }
      </style>
      </div> <!-- End of appContent -->

    </head>
    
    <body>
      <div class="invoice-header">
        <h1>INVOICE</h1>
        <h3>Tile & Sanitaryware Inventory</h3>
      </div>
      
      <div class="invoice-details">
        <p><strong>Invoice Number:</strong> ${data.invoiceNumber}</p>
        <p><strong>Customer Name:</strong> ${data.customerName}</p>
        <p><strong>Invoice Date:</strong> ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}</p>
        <p><strong>Due Date:</strong> ${new Date(data.dueDate).toLocaleDateString('en-IN')}</p>
      </div>
      
      <table>
        <thead>
          <tr>
            <th style="width: 50px">#</th>
            <th>Item Description</th>
            <th style="width: 100px">Quantity</th>
            <th style="width: 120px">Rate</th>
            <th style="width: 120px">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
      </table>
      
      <table style="width: 400px; margin-left: auto">
        <tr>
          <td>Sub Total:</td>
          <td class="text-right">Ã¢â€šÂ¹${data.subtotal.toFixed(2)}</td>
        </tr>
        <tr>
          <td>Discount:</td>
          <td class="text-right">-Ã¢â€šÂ¹${data.discount.toFixed(2)}</td>
        </tr>
        <tr>
          <td>Tax:</td>
          <td class="text-right">Ã¢â€šÂ¹${data.tax.toFixed(2)}</td>
        </tr>
        <tr class="total-row">
          <td>Grand Total:</td>
          <td class="text-right">Ã¢â€šÂ¹${data.total.toFixed(2)}</td>
        </tr>
      </table>
      
      <div style="margin-top: 30px">
        <p><strong>Customer Notes:</strong></p>
        <p>${data.notes || 'N/A'}</p>
      </div>
      
      <div style="margin-top: 20px">
        <p><strong>Terms & Conditions:</strong></p>
        <p style="white-space: pre-line">${data.terms || 'N/A'}</p>
      </div>
      
      <div style="margin-top: 40px; text-align: center">
        <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; cursor: pointer">
          Print Invoice
        </button>
      </div>















     </body>
    </html>
  `;
}
            

// ==========================================
// VIEW SAVED INVOICES FEATURE
// ==========================================

function viewSavedInvoices() {
  const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  
  const container = document.getElementById('invoicesListContainer');
  
  if (invoices.length === 0) {
    container.innerHTML = `
      <div class="alert alert-info text-center">
        <i class="bi bi-info-circle"></i> No saved invoices found
      </div>
    `;
  } else {
    let html = `
      <div class="table-responsive">
        <table class="table table-hover table-bordered">
          <thead class="table-light">
            <tr>
              <th style="width: 15%">Invoice No</th>
              <th style="width: 20%">Customer Name</th>
              <th style="width: 12%">Date</th>
              <th style="width: 12%">Due Date</th>
              <th style="width: 10%" class="text-end">Total</th>
              <th style="width: 18%">Items</th>
              <th style="width: 13%" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    invoices.forEach((inv, index) => {
      const itemsCount = inv.items ? inv.items.length : 0;
      const itemsSummary = inv.items ? inv.items.slice(0, 2).map(i => i.name).join(', ') : '';
      const moreItems = itemsCount > 2 ? ` +${itemsCount - 2} more` : '';
      
      html += `
        <tr>
          <td><strong>${inv.invoiceNumber}</strong></td>
          <td>${escapeHtml(inv.customerName)}</td>
          <td>${new Date(inv.invoiceDate).toLocaleDateString('en-IN')}</td>
          <td>${new Date(inv.dueDate).toLocaleDateString('en-IN')}</td>
          <td class="text-end"><strong>Ã¢â€šÂ¹${inv.total.toFixed(2)}</strong></td>
          <td><small>${escapeHtml(itemsSummary)}${moreItems}</small></td>
          <td class="text-center">
            <button class="btn btn-sm btn-info" onclick="previewSavedInvoice(${index})" title="Preview">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteSavedInvoice(${index})" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
      <div class="alert alert-success">
        <strong>Total Invoices:</strong> ${invoices.length}
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // Show modal
  new bootstrap.Modal(document.getElementById('viewInvoicesModal')).show();
}

function previewSavedInvoice(index) {
  const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  const invoice = invoices[index];
  
  if (!invoice) {
    alert('Invoice not found');
    return;
  }
  
  // Generate and show preview
  const invoiceHTML = generateInvoiceHTML(invoice);
  const previewWindow = window.open('', 'Invoice Preview', 'width=800,height=600');
  previewWindow.document.write(invoiceHTML);
  previewWindow.document.close();
}

function deleteSavedInvoice(index) {
  if (!confirm('Are you sure you want to delete this invoice? This action cannot be undone.')) {
    return;
  }
  
  const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  const deletedInvoice = invoices[index];
  
  invoices.splice(index, 1);
  localStorage.setItem('invoices', JSON.stringify(invoices));
  
  alert(`ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Invoice ${deletedInvoice.invoiceNumber} deleted successfully`);
  
  // Refresh the list
  viewSavedInvoices();
}

// ==========================================
// SHARE INVOICE FEATURE
// ==========================================

// Share Invoice as Image (Primary Method)
async function shareInvoiceAsImage() {
  // Validate customer name
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  if (!customerName) {
    alert('âŒ Please enter customer name before sharing');
    return;
  }
  
  showLoading('Generating image...');
  
  try {
    // Get invoice data
    const invoiceData = collectInvoiceData();
    
    // Generate invoice HTML in hidden container
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = 'position:absolute;left:-9999px;top:0;background:white;width:800px;padding:40px;';
    tempContainer.innerHTML = generateInvoiceHTMLForImage(invoiceData);
    document.body.appendChild(tempContainer);
    
    // Wait for fonts to load
    await document.fonts.ready;
    
    // Convert to canvas
    const canvas = await html2canvas(tempContainer, {
      backgroundColor: '#ffffff',
      scale: 2,
      logging: false,
      windowWidth: 800,
      windowHeight: tempContainer.scrollHeight
    });
    
    // Remove temp container
    document.body.removeChild(tempContainer);
    
    hideLoading();
    
    // Convert canvas to blob
    canvas.toBlob(async (blob) => {
      const fileName = `Invoice_${invoiceData.invoiceNumber}_${invoiceData.customerName.replace(/\s+/g, '_')}.png`;
      const file = new File([blob], fileName, { type: 'image/png' });
      
      // Try Web Share API (mobile & modern browsers)
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            title: `Invoice ${invoiceData.invoiceNumber}`,
            text: `Invoice for ${invoiceData.customerName} - â‚¹${invoiceData.total.toFixed(2)}`,
            files: [file]
          });
          console.log('âœ… Invoice shared successfully');
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error('Share failed:', err);
            fallbackDownloadImage(canvas, fileName);
          }
        }
      } else {
        // Fallback: Download image
        fallbackDownloadImage(canvas, fileName);
      }
    }, 'image/png', 0.95);
    
  } catch (error) {
    hideLoading();
    console.error('Error generating image:', error);
    alert('âŒ Error generating invoice image. Please try again.');
  }
}

/**
 * ==========================================
 * âœ… NEW: Share Invoice Image on WhatsApp Number
 * ==========================================
 */

// Open WhatsApp number input modal
function shareImageToWhatsAppNumber() {
  // Validate customer name first
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  if (!customerName) {
    alert('âŒ Please enter customer name before sharing');
    return;
  }
  
  // Load saved number if exists
  const savedNumber = localStorage.getItem('whatsappNumber');
  if (savedNumber) {
    document.getElementById('whatsappNumberInput').value = savedNumber;
    document.getElementById('saveWhatsAppNumber').checked = true;
  }
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('whatsappNumberModal'));
  modal.show();
  
  // Focus input after modal opens
  setTimeout(() => {
    document.getElementById('whatsappNumberInput').focus();
  }, 500);
}

// Send invoice image to specific WhatsApp number (FINAL FIX - NO STRING ESCAPING ISSUES)
async function sendInvoiceToWhatsApp() {
  const numberInput = document.getElementById('whatsappNumberInput');
  const phoneNumber = numberInput.value.trim();
  
  // Validation
  if (!phoneNumber) {
    alert('âŒ Please enter WhatsApp number');
    numberInput.focus();
    return;
  }
  
  if (!/^[0-9]{10}$/.test(phoneNumber)) {
    alert('âŒ Please enter a valid 10-digit mobile number');
    numberInput.focus();
    return;
  }
  
  // Save number if checkbox checked
  if (document.getElementById('saveWhatsAppNumber').checked) {
    localStorage.setItem('whatsappNumber', phoneNumber);
  }
  
  // Close number input modal
  const numberModal = bootstrap.Modal.getInstance(document.getElementById('whatsappNumberModal'));
  if (numberModal) {
    numberModal.hide();
  }
  
  // Detect iOS
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  
  // Show loading
  showLoading('Preparing invoice for WhatsApp...');
  
  try {
    // Get invoice data
    const invoiceData = collectInvoiceData();
    
    // Generate invoice HTML
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = 'position:absolute;left:-9999px;top:0;background:white;width:800px;padding:40px;';
    tempContainer.innerHTML = generateInvoiceHTMLForImage(invoiceData);
    document.body.appendChild(tempContainer);
    
    await document.fonts.ready;
    
    // Convert to canvas
    const canvas = await html2canvas(tempContainer, {
      backgroundColor: '#ffffff',
      scale: 2,
      logging: false,
      windowWidth: 800,
      windowHeight: tempContainer.scrollHeight
    });
    
    document.body.removeChild(tempContainer);
    
    hideLoading();
    
    // Full phone number with country code
    const fullNumber = '91' + phoneNumber;
    
    // Convert canvas to blob
    canvas.toBlob(async (blob) => {
      const fileName = 'Invoice_' + invoiceData.invoiceNumber + '_' + invoiceData.customerName.replace(/\s+/g, '_') + '.png';
      
      // iOS FIX: Different handling for iPhone
      if (isIOS) {
        // Step 1: Show the image in a new window for user to save manually
        const imageUrl = canvas.toDataURL('image/png');
        const newWindow = window.open('', '_blank');
        
        if (newWindow) {
          // âœ… FINAL FIX: Build HTML using DOM methods (no string escaping needed!)
          const doc = newWindow.document;
          doc.open();
          doc.write('<!DOCTYPE html><html><head>');
          doc.write('<meta name="viewport" content="width=device-width, initial-scale=1">');
          doc.write('<title>Invoice Image</title>');
          
          // Add styles
          const style = doc.createElement('style');
          style.textContent = 
            'body { margin: 0; padding: 20px; text-align: center; background: #f0f0f0; font-family: Arial, sans-serif; }' +
            'img { max-width: 100%; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-top: 20px; }' +
            '.instructions { background: white; padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 90%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }' +
            'button { background: #25D366; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; margin: 10px; cursor: pointer; }' +
            'ol { text-align: left; line-height: 1.8; }';
          doc.head.appendChild(style);
          doc.write('</head><body>');
          
          // Add instructions
          doc.write('<div class="instructions">');
          doc.write('<h2 style="color: #25D366;">ðŸ“± Save & Share Invoice</h2>');
          doc.write('<ol>');
          doc.write('<li><strong>Tap and hold</strong> on the invoice image below</li>');
          doc.write('<li>Select <strong>"Add to Photos"</strong> or <strong>"Save Image"</strong></li>');
          doc.write('<li>Click the <strong>"Open WhatsApp"</strong> button below</li>');
          doc.write('<li>In WhatsApp, tap <strong>ðŸ“Ž</strong> â†’ <strong>Gallery</strong> â†’ Select invoice â†’ Send</li>');
          doc.write('</ol>');
          doc.write('<button id="waBtn">ðŸ“± Open WhatsApp Chat</button>');
          doc.write('</div>');
          
          // Add image
          doc.write('<img src="' + imageUrl + '" alt="Invoice">');
          
          doc.write('</body></html>');
          doc.close();
          
          // Add WhatsApp button click handler
          const waBtn = doc.getElementById('waBtn');
          if (waBtn) {
            waBtn.onclick = function() {
              const waUrl = 'whatsapp://send?phone=' + fullNumber + '&text=' + 
                encodeURIComponent('Invoice ' + invoiceData.invoiceNumber + ' - â‚¹' + invoiceData.total.toFixed(2));
              newWindow.location.href = waUrl;
            };
          }
          
        } else {
          // Popup blocked - fallback to download
          const link = document.createElement('a');
          link.download = fileName;
          link.href = imageUrl;
          link.click();
          
          // Open WhatsApp after short delay
          setTimeout(function() {
            window.location.href = 'whatsapp://send?phone=' + fullNumber + '&text=' + 
              encodeURIComponent('Invoice ' + invoiceData.invoiceNumber);
          }, 500);
        }
        
      } else {
        // Android/Desktop: Standard download method
        const link = document.createElement('a');
        link.download = fileName;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        // Show notification
        alert('âœ… Invoice downloaded: ' + fileName + '\n\nðŸ“± WhatsApp will open now. Attach the downloaded invoice from Gallery.');
        
        // Open WhatsApp
        setTimeout(function() {
          const message = encodeURIComponent(
            'ðŸ“„ Invoice ' + invoiceData.invoiceNumber + '\n' +
            'Customer: ' + invoiceData.customerName + '\n' +
            'Amount: â‚¹' + invoiceData.total.toFixed(2)
          );
          window.location.href = 'whatsapp://send?phone=' + fullNumber + '&text=' + message;
        }, 1000);
      }
      
    }, 'image/png', 0.95);
    
  } catch (error) {
    hideLoading();
    console.error('Error generating invoice image:', error);
    alert('âŒ Error generating invoice image. Please try again.');
  }
}




// Helper: Detect mobile device
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Helper: Download invoice image
function downloadInvoiceImage(canvas, fileName) {
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
}

// Fallback: Download image and open WhatsApp
function fallbackWhatsAppShare(phoneNumber, invoiceData, canvas, fileName) {
  // Download image
  downloadInvoiceImage(canvas, fileName);
  
  // Prepare WhatsApp message
  const message = encodeURIComponent(
    `ðŸ“„ Invoice ${invoiceData.invoiceNumber}\n` +
    `Customer: ${invoiceData.customerName}\n` +
    `Amount: â‚¹${invoiceData.total.toFixed(2)}`
  );
  
  // Open WhatsApp with the specific number
  const whatsappUrl = isMobileDevice() 
    ? `whatsapp://send?phone=${phoneNumber}&text=${message}`
    : `https://wa.me/${phoneNumber}?text=${message}`;
  
  if (isMobileDevice()) {
    // Mobile: Open WhatsApp app directly
    window.location.href = whatsappUrl;
    
    setTimeout(() => {
      alert('ðŸ“± Steps to send invoice:\n\n1. Tap attach button (ðŸ“Ž)\n2. Select "Gallery" or "Photos"\n3. Choose the downloaded invoice\n4. Tap Send âœ“\n\nThe invoice image is saved in your downloads/gallery.');
    }, 1000);
  } else {
    // Desktop: Open WhatsApp Web
    window.open(whatsappUrl, '_blank');
    alert('âœ… Invoice image downloaded!\nðŸ“± WhatsApp Web opened - please attach the downloaded image and send.');
  }
}


// Fallback: Open WhatsApp Web with message and download image
function fallbackWhatsAppShare(phoneNumber, invoiceData, canvas, fileName) {
  // Download image
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
  
  // Open WhatsApp Web with pre-filled message
  const message = encodeURIComponent(
    `ðŸ“„ Invoice ${invoiceData.invoiceNumber}\n` +
    `Customer: ${invoiceData.customerName}\n` +
    `Amount: â‚¹${invoiceData.total.toFixed(2)}\n\n` +
    `Invoice image downloaded. Please attach and send.`
  );
  
  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
  window.open(whatsappUrl, '_blank');
  
  alert('âœ… Invoice image downloaded!\nðŸ“± WhatsApp opened - please attach the downloaded image and send.');
}




    
// Fallback: Download image if share not supported
function fallbackDownloadImage(canvas, fileName) {
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
  alert('âœ… Invoice image downloaded! You can now share it from your downloads.');
}

// Generate clean invoice HTML for image conversion
function generateInvoiceHTMLForImage(data) {
  let itemsHTML = '';
  data.items.forEach((item, index) => {
    itemsHTML += `
      <tr>
        <td style="text-align:center;padding:8px;border:1px solid #ddd;">${index + 1}</td>
        <td style="padding:8px;border:1px solid #ddd;">${escapeHtml(item.name)}</td>
        <td style="text-align:center;padding:8px;border:1px solid #ddd;">${item.quantity}</td>
        <td style="text-align:right;padding:8px;border:1px solid #ddd;">â‚¹${item.rate.toFixed(2)}</td>
        <td style="text-align:right;padding:8px;border:1px solid #ddd;">â‚¹${item.amount.toFixed(2)}</td>
      </tr>
    `;
  });
  
  return `
    <div style="font-family:Arial,sans-serif;padding:20px;max-width:800px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:30px;border-bottom:3px solid #0d6efd;padding-bottom:20px;">
        <h1 style="margin:0;font-size:36px;color:#0d6efd;">INVOICE</h1>
        <h2 style="margin:10px 0;font-size:20px;color:#333;">Tile & Sanitaryware Inventory</h2>
      </div>
      
      <div style="display:flex;justify-content:space-between;margin-bottom:30px;">
        <div style="flex:1;">
          <p style="margin:5px 0;"><strong>Invoice Number:</strong> ${data.invoiceNumber}</p>
          <p style="margin:5px 0;"><strong>Customer Name:</strong> ${escapeHtml(data.customerName)}</p>
        </div>
        <div style="flex:1;text-align:right;">
          <p style="margin:5px 0;"><strong>Invoice Date:</strong> ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}</p>
          <p style="margin:5px 0;"><strong>Due Date:</strong> ${new Date(data.dueDate).toLocaleDateString('en-IN')}</p>
        </div>
      </div>
      
      <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
        <thead>
          <tr style="background:#f8f9fa;">
            <th style="padding:10px;border:1px solid #ddd;text-align:center;width:50px;">#</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:left;">Item Description</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:center;width:80px;">Quantity</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:right;width:100px;">Rate</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:right;width:120px;">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
      </table>
      
      <div style="text-align:right;margin-bottom:20px;">
        <table style="margin-left:auto;width:300px;">
          <tr>
            <td style="padding:5px;"><strong>Sub Total:</strong></td>
            <td style="padding:5px;text-align:right;">â‚¹${data.subtotal.toFixed(2)}</td>
          </tr>
          <tr>
            <td style="padding:5px;color:#dc3545;"><strong>Discount:</strong></td>
            <td style="padding:5px;text-align:right;color:#dc3545;">-â‚¹${data.discount.toFixed(2)}</td>
          </tr>
          <tr>
            <td style="padding:5px;"><strong>Tax:</strong></td>
            <td style="padding:5px;text-align:right;">â‚¹${data.tax.toFixed(2)}</td>
          </tr>
          <tr style="border-top:2px solid #000;">
            <td style="padding:10px;font-size:18px;"><strong>Grand Total:</strong></td>
            <td style="padding:10px;text-align:right;font-size:18px;"><strong>â‚¹${data.total.toFixed(2)}</strong></td>
          </tr>
        </table>
      </div>
      
      ${data.notes ? `
        <div style="margin-bottom:20px;">
          <p style="margin:5px 0;"><strong>Customer Notes:</strong></p>
          <p style="margin:5px 0;padding:10px;background:#f8f9fa;border-left:3px solid #0d6efd;">${escapeHtml(data.notes)}</p>
        </div>
      ` : ''}
      
      ${data.terms ? `
        <div style="margin-bottom:20px;">
          <p style="margin:5px 0;"><strong>Terms & Conditions:</strong></p>
          <p style="margin:5px 0;white-space:pre-line;font-size:12px;color:#666;">${escapeHtml(data.terms)}</p>
        </div>
      ` : ''}
      
      <div style="text-align:center;margin-top:30px;padding-top:20px;border-top:1px solid #ddd;color:#666;font-size:12px;">
        <p>Thank you for your business!</p>
      </div>
    </div>
  `;
}

// Share Invoice as PDF
async function shareInvoiceAsPDF() {
  alert('ðŸ“„ PDF sharing coming soon! For now, use Preview â†’ Print to save as PDF.');
  // You can implement PDF generation using jsPDF or html2pdf.js later
}

// Share via WhatsApp (Text message)
function shareViaWhatsApp() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('âŒ Please enter customer name');
    return;
  }
  
  const message = generateShareText(invoiceData);
  const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
  window.open(whatsappUrl, '_blank');
}

// Share via Email (Text)
function shareViaEmail() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('âŒ Please enter customer name');
    return;
  }
  
  const subject = `Invoice ${invoiceData.invoiceNumber} from Tile & Sanitaryware Inventory`;
  const body = generateShareText(invoiceData);
  const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailtoUrl;
}

// Share via SMS (Text)
function shareViaSMS() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('âŒ Please enter customer name');
    return;
  }
  
  const message = generateShareText(invoiceData);
  const smsUrl = `sms:?body=${encodeURIComponent(message)}`;
  window.location.href = smsUrl;
}

// Generate text message for sharing
function generateShareText(data) {
  let text = `ðŸ§¾ INVOICE\n\n`;
  text += `Invoice No: ${data.invoiceNumber}\n`;
  text += `Customer: ${data.customerName}\n`;
  text += `Date: ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}\n`;
  text += `Due Date: ${new Date(data.dueDate).toLocaleDateString('en-IN')}\n\n`;
  
  text += `ITEMS:\n`;
  data.items.forEach((item, i) => {
    text += `${i + 1}. ${item.name} x ${item.quantity} = â‚¹${item.amount.toFixed(2)}\n`;
  });
  
  text += `\n`;
  text += `Sub Total: â‚¹${data.subtotal.toFixed(2)}\n`;
  if (data.discount > 0) {
    text += `Discount: -â‚¹${data.discount.toFixed(2)}\n`;
  }
  if (data.tax > 0) {
    text += `Tax: â‚¹${data.tax.toFixed(2)}\n`;
  }
  text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  text += `TOTAL: â‚¹${data.total.toFixed(2)}\n\n`;
  
  text += `Thank you for your business!\n`;
  text += `- Tile & Sanitaryware Inventory`;
  
  return text;
}

// Loading indicator helpers
function showLoading(message = 'Processing...') {
  let loader = document.getElementById('globalLoader');
  if (!loader) {
    loader = document.createElement('div');
    loader.id = 'globalLoader';
    loader.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px 40px;border-radius:8px;z-index:10000;font-size:16px;';
    document.body.appendChild(loader);
  }
  loader.textContent = message;
  loader.style.display = 'block';
}

function hideLoading() {
  const loader = document.getElementById('globalLoader');
  if (loader) {
    loader.style.display = 'none';
  }
}

/**
 * ==========================================
 * QUICK CREATE PLUS ICON FUNCTIONALITY
 * ==========================================
 */

// Toggle Quick Create Menu
function toggleQuickCreate() {
  const menu = document.getElementById('quickCreateMenu');
  const btn = document.getElementById('quickCreateBtn');
  
  if (menu.classList.contains('show')) {
    menu.classList.remove('show');
    btn.classList.remove('active');
  } else {
    menu.classList.add('show');
    btn.classList.add('active');
  }
}

// Quick Create Action (placeholder for future implementation)
function quickCreateAction(action) {
  console.log('Quick Create Action:', action);
  
  // For now, show alert that feature is coming soon
  alert('â³ "' + action.replace(/([A-Z])/g, ' $1').trim() + '" feature coming soon!\n\nThis will be implemented in the next phase.');
  
  // Close menu after action
  toggleQuickCreate();
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
  const menu = document.getElementById('quickCreateMenu');
  const btn = document.getElementById('quickCreateBtn');
  
  if (menu && btn) {
    if (!menu.contains(event.target) && !btn.contains(event.target)) {
      menu.classList.remove('show');
      btn.classList.remove('active');
    }
  }
});

// Prevent menu from closing when clicking inside
document.addEventListener('DOMContentLoaded', function() {
  const menu = document.getElementById('quickCreateMenu');
  if (menu) {
    menu.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }
});




    

    
  </script>






    
    </script>

  <!-- Ã¢Å“â€¦ NEW: Change Password Modal -->
  <div id="changePasswordModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-key me-2"></i>Change Password
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Step 1: Verify Current Password -->
          <div id="verifyPasswordStep">
            <p class="text-muted">Enter your current password to continue</p>
            <div class="mb-3">
              <label class="form-label">Current Password</label>
              <input 
                type="password" 
                id="currentPasswordInput" 
                class="form-control" 
                placeholder="Enter current password"
                required
              >
            </div>
            <div class="d-grid">
              <button class="btn btn-primary" onclick="verifyCurrentPassword()">
                Continue
              </button>
            </div>
          </div>
          
          <!-- Step 2: Enter New Password -->
          <div id="newPasswordStep" style="display: none;">
            <p class="text-muted">Choose a new password (minimum 6 characters)</p>
            <div class="mb-3">
              <label class="form-label">New Password</label>
              <input 
                type="password" 
                id="newPasswordInput" 
                class="form-control" 
                placeholder="Enter new password"
                minlength="6"
                required
              >
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm New Password</label>
              <input 
                type="password" 
                id="confirmPasswordInput" 
                class="form-control" 
                placeholder="Re-enter new password"
                minlength="6"
                required
              >
            </div>
            <div class="d-grid">
              <button class="btn btn-success" onclick="submitNewPassword()">
                <i class="bi bi-check-circle me-2"></i>Change Password
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- âœ… NEW: WhatsApp Number Input Modal -->
<div class="modal fade" id="whatsappNumberModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-whatsapp"></i> Share Invoice on WhatsApp
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> Enter the recipient's WhatsApp number (with country code)
        </div>
        
        <div class="mb-3">
          <label class="form-label">WhatsApp Number</label>
          <div class="input-group">
            <span class="input-group-text">+91</span>
            <input type="tel" 
                   class="form-control" 
                   id="whatsappNumberInput" 
                   placeholder="9876543210" 
                   maxlength="10"
                   pattern="[0-9]{10}"
                   required>
          </div>
          <small class="text-muted">Enter 10-digit mobile number (without +91)</small>
        </div>
        
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="saveWhatsAppNumber">
          <label class="form-check-label" for="saveWhatsAppNumber">
            Remember this number for next time
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="sendInvoiceToWhatsApp()">
          <i class="bi bi-whatsapp"></i> Send to WhatsApp
        </button>
      </div>
    </div>
  </div>
</div>


<!-- ==========================================
     QUICK CREATE PLUS BUTTON 
     ========================================== -->

<!-- Floating Plus Button -->
<button class="quick-create-btn" id="quickCreateBtn" onclick="toggleQuickCreate()">
  <i class="bi bi-plus-lg"></i>
</button>

<!-- Quick Create Dropdown Menu -->
<div class="quick-create-menu" id="quickCreateMenu">
  
  <!-- Header -->
  <div class="quick-create-header">
    Quick Create
  </div>
  
  <!-- GENERAL Section -->
  <div class="quick-create-section">
    <div class="quick-create-section-title">GENERAL</div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('addUsers')">
      <i class="bi bi-person-plus"></i>
      <span>Add Users</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('item')">
      <i class="bi bi-box"></i>
      <span>Item</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('itemGroups')">
      <i class="bi bi-collection"></i>
      <span>Item Groups</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('inventoryAdjustments')">
      <i class="bi bi-sliders"></i>
      <span>Inventory Adjustments</span>
    </div>
  </div>
  
  <!-- SALES Section -->
  <div class="quick-create-section">
    <div class="quick-create-section-title">SALES</div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('customer')">
      <i class="bi bi-person"></i>
      <span>Customer</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('invoices')">
      <i class="bi bi-receipt"></i>
      <span>Invoices</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('salesReceipts')">
      <i class="bi bi-cash-stack"></i>
      <span>Sales Receipts</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('salesOrder')">
      <i class="bi bi-cart-check"></i>
      <span>Sales Order</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('packages')">
      <i class="bi bi-box-seam"></i>
      <span>Packages</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('shipment')">
      <i class="bi bi-truck"></i>
      <span>Shipment</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('customerPayment')">
      <i class="bi bi-credit-card"></i>
      <span>Customer Payment</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('creditNotes')">
      <i class="bi bi-file-text"></i>
      <span>Credit Notes</span>
    </div>
  </div>
  
  <!-- PURCHASES Section -->
  <div class="quick-create-section">
    <div class="quick-create-section-title">PURCHASES</div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('vendor')">
      <i class="bi bi-building"></i>
      <span>Vendor</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('expenses')">
      <i class="bi bi-cash-coin"></i>
      <span>Expenses</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('bills')">
      <i class="bi bi-file-earmark-text"></i>
      <span>Bills</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('purchaseOrders')">
      <i class="bi bi-bag-check"></i>
      <span>Purchase Orders</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('purchaseReceives')">
      <i class="bi bi-inbox"></i>
      <span>Purchase Receives</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('vendorPayment')">
      <i class="bi bi-wallet2"></i>
      <span>Vendor Payment</span>
    </div>
    
    <div class="quick-create-item disabled" onclick="quickCreateAction('vendorCredits')">
      <i class="bi bi-arrow-left-circle"></i>
      <span>Vendor Credits</span>
    </div>
  </div>
  
</div>






    

    
</body>
</html>

</body>
</html>


































































